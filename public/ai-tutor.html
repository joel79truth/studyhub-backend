<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyHub AI Assistant - LUANAR</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: rgba(15, 23, 42, 0.98);
      border-right: 1px solid rgba(59, 130, 246, 0.2);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .sidebar-subtitle {
      font-size: 13px;
      color: #94a3b8;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .sidebar-option {
      padding: 12px 16px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-option:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .sidebar-option-icon {
      font-size: 20px;
    }

    .sidebar-option-text {
      flex: 1;
    }

    .sidebar-option-label {
      font-size: 14px;
      font-weight: 500;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .sidebar-option-desc {
      font-size: 12px;
      color: #94a3b8;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid rgba(59, 130, 246, 0.2);
    }

    .sidebar-back-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* Overlay */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 999;
    }

    .sidebar-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Main Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f8fafc;
      max-width: 100%;
      margin: 0 auto;
    }

    /* Header */
    .chat-header {
      background: rgba(15, 23, 42, 0.98);
      color: white;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }

    .menu-toggle {
      width: 40px;
      height: 40px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 10px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .menu-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .header-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bot-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header-info h1 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .status {
      font-size: 12px;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .clear-btn {
      width: 40px;
      height: 40px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      color: #ef4444;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .clear-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Messages Area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #f8fafc;
    }

    .messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .bot-msg-avatar {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .user-msg-avatar {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .message-content {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message-bubble {
      padding: 14px 16px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 14px;
    }

    .message.bot .message-bubble {
      background: white;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .message-time {
      font-size: 11px;
      color: #94a3b8;
      padding: 0 4px;
    }

    .message.user .message-time {
      text-align: right;
    }

    /* Typing Animation */
    .typing-indicator {
      display: none;
      padding: 14px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      width: fit-content;
    }

    .typing-indicator.show {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .typing-text {
      font-size: 13px;
      color: #64748b;
      margin-right: 6px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: #94a3b8;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }

    /* Welcome Screen */
    .welcome-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .welcome-icon {
      font-size: 56px;
      margin-bottom: 20px;
    }

    .welcome-title {
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .welcome-subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .quick-prompts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      max-width: 600px;
      margin: 0 auto;
    }

    .prompt-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
    }

    .prompt-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
      transform: translateY(-2px);
    }

    .prompt-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .prompt-title {
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .prompt-desc {
      font-size: 12px;
      color: #64748b;
      line-height: 1.4;
    }

    /* Input Area */
    .input-container {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 900px;
      margin: 0 auto;
    }

    #messageInput {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      resize: none;
      max-height: 120px;
      transition: all 0.2s;
      font-family: inherit;
    }

    #messageInput:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #messageInput::placeholder {
      color: #94a3b8;
    }

    #sendBtn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    #sendBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    #sendBtn:active {
      transform: translateY(0);
    }

    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Code & Formula Blocks */
    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 8px 0;
      overflow-x: auto;
    }

    .formula-block {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 8px 0;
      font-family: 'Times New Roman', serif;
      font-size: 14px;
    }

    .message-bubble ul, .message-bubble ol {
      margin-left: 20px;
      margin-top: 8px;
    }

    .message-bubble li {
      margin-bottom: 4px;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        width: 260px;
      }

      .chat-header {
        padding: 12px 16px;
      }

      .header-info h1 {
        font-size: 15px;
      }

      .bot-avatar {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .messages-container {
        padding: 16px;
      }

      .message-content {
        max-width: 85%;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .message-bubble {
        font-size: 13px;
        padding: 12px 14px;
      }

      .welcome-title {
        font-size: 20px;
      }

      .welcome-icon {
        font-size: 48px;
      }

      .quick-prompts {
        grid-template-columns: 1fr;
      }

      .input-container {
        padding: 16px;
      }

      #messageInput {
        font-size: 14px;
        padding: 12px 14px;
      }

      #sendBtn {
        width: 44px;
        height: 44px;
      }
    }

    /* Disable heavy effects on mobile for performance */
    @media (max-width: 768px) {
      * {
        animation: none !important;
      }

      .message {
        animation: none !important;
      }

      .sidebar,
      .sidebar-overlay {
        transition: none !important;
      }

      .message,
      .prompt-card,
      .sidebar-option,
      .menu-toggle,
      .clear-btn,
      #sendBtn {
        transition: transform 0.1s ease !important;
      }

      .typing-dot {
        animation: typing 1.4s infinite !important;
      }

      .status-dot {
        animation: pulse 2s infinite !important;
      }
    }
  </style>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RP8NY538W2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RP8NY538W2');
</script>
</head>
<body>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">StudyHub AI</div>
    <div class="sidebar-subtitle">Your Academic Assistant</div>
  </div>

  <div class="sidebar-content">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Quick Actions</div>
      <div class="sidebar-option" onclick="sendQuickMessage('Help me solve a math problem'); closeSidebar();">
        <div class="sidebar-option-icon">üìê</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Math Solver</div>
          <div class="sidebar-option-desc">Equations & calculations</div>
        </div>
      </div>
      <div class="sidebar-option" onclick="sendQuickMessage('Explain a scientific concept'); closeSidebar();">
        <div class="sidebar-option-icon">üî¨</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Science Help</div>
          <div class="sidebar-option-desc">Concepts & theories</div>
        </div>
      </div>
      <div class="sidebar-option" onclick="sendQuickMessage('Give me study tips'); closeSidebar();">
        <div class="sidebar-option-icon">üìö</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Study Tips</div>
          <div class="sidebar-option-desc">Effective learning methods</div>
        </div>
      </div>
      <div class="sidebar-option" onclick="sendQuickMessage('Help me write an essay'); closeSidebar();">
        <div class="sidebar-option-icon">‚úçÔ∏è</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Writing Help</div>
          <div class="sidebar-option-desc">Essays & reports</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Resources</div>
      <div class="sidebar-option" onclick="sendQuickMessage('Generate a citation'); closeSidebar();">
        <div class="sidebar-option-icon">üìù</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Citations</div>
          <div class="sidebar-option-desc">APA, MLA, Chicago formats</div>
        </div>
      </div>
      <div class="sidebar-option" onclick="sendQuickMessage('Research methodology help'); closeSidebar();">
        <div class="sidebar-option-icon">üîç</div>
        <div class="sidebar-option-text">
          <div class="sidebar-option-label">Research Help</div>
          <div class="sidebar-option-desc">Methodology & analysis</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-footer">
    <button class="sidebar-back-btn" onclick="window.history.back()">
      ‚Üê Back to Home
    </button>
  </div>
</div>

<!-- Main Chat Container -->
<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="header-content">
      <div class="bot-avatar">ü§ñ</div>
      <div class="header-info">
        <h1>StudyHub AI Assistant</h1>
        <div class="status">
          <span class="status-dot"></span>
          <span>Online</span>
        </div>
      </div>
    </div>
    <button class="clear-btn" onclick="clearChat()" title="Clear Chat">üóëÔ∏è</button>
  </div>

  <!-- Messages -->
  <div class="messages-container" id="messagesContainer">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-icon">üéì</div>
      <h2 class="welcome-title">Welcome to StudyHub AI</h2>
      <p class="welcome-subtitle">Your intelligent academic companion for learning, problem-solving, and research support</p>
      
      <div class="quick-prompts">
        <div class="prompt-card" onclick="sendQuickMessage('Help me solve a quadratic equation')">
          <div class="prompt-icon">üßÆ</div>
          <div class="prompt-title">Math & Science</div>
          <div class="prompt-desc">Solve equations and explain formulas</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('Help me write an essay about climate change')">
          <div class="prompt-icon">‚úçÔ∏è</div>
          <div class="prompt-title">Writing Support</div>
          <div class="prompt-desc">Essays, reports, and citations</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('What are effective study techniques?')">
          <div class="prompt-icon">üìñ</div>
          <div class="prompt-title">Study Strategies</div>
          <div class="prompt-desc">Learn effective study methods</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('Explain photosynthesis')">
          <div class="prompt-icon">üî¨</div>
          <div class="prompt-title">Concept Explanations</div>
          <div class="prompt-desc">Understand complex topics</div>
        </div>
      </div>
    </div>
    
    <div class="message bot" style="display:none;">
      <div class="message-avatar bot-msg-avatar">ü§ñ</div>
      <div class="message-content">
        <div class="typing-indicator" id="typingIndicator">
          <span class="typing-text">AI is typing</span>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-container">
    <div class="input-wrapper">
      <textarea 
        id="messageInput" 
        placeholder="Ask me anything... (e.g., 'Solve x¬≤ + 5x + 6 = 0')"
        rows="1"
      ></textarea>
      <button id="sendBtn" onclick="sendMessage()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
// ========================
// Sidebar Functions
// ========================
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// ========================
// GPT API Call
// ========================
async function fetchGPTResponse(message) {
  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });
    const data = await res.json();
    return data.reply;
  } catch (err) {
    console.error("GPT fetch error:", err);
    return "I apologize, but I'm unable to connect to the AI service right now. Please try again in a moment.";
  }
}

// ========================
// Knowledge Base
// ========================
const knowledgeBase = {
  greetings: {
    patterns: ['hello', 'hi', 'hey', 'good morning', 'good afternoon', 'good evening', 'greetings'],
    responses: [
      "Hello! I'm your StudyHub AI Assistant. How can I help you with your studies today?",
      "Hi there! Ready to tackle some academic challenges together?",
      "Greetings! What would you like to learn or solve today?"
    ]
  },
  math: {
    patterns: ['math', 'equation', 'solve', 'calculate', 'algebra', 'calculus', 'geometry', 'trigonometry'],
    handler: (msg) => solveMathProblem(msg)
  },
  study: {
    patterns: ['study', 'learn', 'memorize', 'remember', 'focus', 'exam', 'test', 'preparation'],
    responses: [
      `**Effective Study Techniques:**

üìö **Study Methods:**
‚Ä¢ Pomodoro Technique (25-min focus sessions)
‚Ä¢ Active Recall (test yourself)
‚Ä¢ Spaced Repetition (review over time)
‚Ä¢ Feynman Technique (teach to learn)

üí° **Focus Tips:**
‚Ä¢ Create a dedicated study space
‚Ä¢ Minimize distractions
‚Ä¢ Take regular breaks
‚Ä¢ Use the 2-minute rule to start

Would you like specific tips for a subject or exam?`
    ]
  },
  agriculture: {
    patterns: ['agriculture', 'farming', 'crop', 'soil', 'plant', 'livestock', 'harvest'],
    responses: [
      `**Agricultural Sciences Help:**

üå± **Crop Science:** Plant biology, production, pest management
üêÑ **Animal Science:** Nutrition, breeding, health
üåæ **Agribusiness:** Management, economics, marketing
üåç **Soil Science:** Fertility, conservation, analysis

What specific topic would you like to explore?`
    ]
  },
  science: {
    patterns: ['biology', 'chemistry', 'physics', 'photosynthesis', 'cell', 'atom', 'molecule', 'reaction'],
    handler: (msg) => {
      if (msg.toLowerCase().includes('photosynthesis')) return explainPhotosynthesis();
      return `I can explain various scientific concepts in Biology, Chemistry, and Physics. What would you like to learn about?`;
    }
  },
  writing: {
    patterns: ['write', 'essay', 'paper', 'report', 'citation', 'grammar', 'reference'],
    responses: [
      `**Academic Writing Assistance:**

‚úçÔ∏è I can help with:
‚Ä¢ Essay structure and outlines
‚Ä¢ Research papers
‚Ä¢ Citations (APA, MLA, Chicago)
‚Ä¢ Grammar and clarity
‚Ä¢ References and bibliographies

What writing task can I help with?`
    ]
  },
  research: {
    patterns: ['research', 'thesis', 'dissertation', 'methodology', 'literature review', 'data analysis'],
    responses: [
      `**Research Guidance:**

üìä Research Process:
1. Define research question
2. Literature review
3. Choose methodology
4. Collect data
5. Analyze results
6. Draw conclusions

What aspect of research do you need help with?`
    ]
  }
};

// ========================
// Message History
// ========================
let messageHistory = [];

// ========================
// DOM Ready
// ========================
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('messageInput');

  // Auto-resize textarea
  input.addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  // Send on Enter
  input.addEventListener('keypress', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
});

// ========================
// Send Message
// ========================
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  if (!message) return;

  // Hide welcome screen
  const welcomeScreen = document.getElementById('welcomeScreen');
  if (welcomeScreen) welcomeScreen.style.display = 'none';

  // Add user message
  addMessage(message, 'user');

  // Clear input
  input.value = '';
  input.style.height = 'auto';

  // Show typing
  showTyping();

  // Simulate delay for typing animation
  await new Promise(resolve => setTimeout(resolve, 800));

  try {
    const lowerMessage = message.toLowerCase();

    // Check Knowledge Base
    let response;
    for (const [category, data] of Object.entries(knowledgeBase)) {
      if (data.patterns.some(p => lowerMessage.includes(p))) {
        response = data.handler ? data.handler(message) :
                   data.responses[Math.floor(Math.random() * data.responses.length)];
        break;
      }
    }

    // Fallback to GPT
    if (!response) {
      response = await fetchGPTResponse(message);
    }

    hideTyping();
    addMessage(response, 'bot');
  } catch (err) {
    hideTyping();
    addMessage("I encountered an error. Please try again.", 'bot');
    console.error(err);
  }
}

// ========================
// Add Message
// ========================
function addMessage(text, sender) {
  const container = document.getElementById('messagesContainer');
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  const avatar = sender === 'bot' ? 'ü§ñ' : 'üë§';
  const avatarClass = sender === 'bot' ? 'bot-msg-avatar' : 'user-msg-avatar';

  messageDiv.innerHTML = `
    <div class="message-avatar ${avatarClass}">${avatar}</div>
    <div class="message-content">
      <div class="message-bubble">${formatMessage(text)}</div>
      <div class="message-time">${time}</div>
    </div>
  `;

  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;

  messageHistory.push({ text, sender, time });
}

// ========================
// Format Message
// ========================
function formatMessage(text) {
  text = text.replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>');
  text = text.replace(/\[formula\]([\s\S]*?)\[\/formula\]/g, '<div class="formula-block">$1</div>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\n/g, '<br>');
  return text;
}

// ========================
// Typing Indicator
// ========================
function showTyping() {
  document.getElementById('typingIndicator').classList.add('show');
  const container = document.getElementById('messagesContainer');
  container.scrollTop = container.scrollHeight;
}

function hideTyping() {
  document.getElementById('typingIndicator').classList.remove('show');
}

// ========================
// Math Solver
// ========================
function solveMathProblem(message) {
  const match = message.match(/([+-]?\d*)\s*x¬≤\s*([+-]?\s*\d+)\s*x\s*([+-]?\s*\d+)\s*=\s*0/);
  if (match) {
    let a = match[1] === '' || match[1] === '+' ? 1 : match[1] === '-' ? -1 : parseInt(match[1]);
    let b = parseInt(match[2].replace(/\s/g, ''));
    let c = parseInt(match[3].replace(/\s/g, ''));
    const discriminant = b * b - 4 * a * c;

    if (discriminant > 0) {
      const x1 = (-b + Math.sqrt(discriminant)) / (2 * a);
      const x2 = (-b - Math.sqrt(discriminant)) / (2 * a);
      return `**Solution for ${a}x¬≤ ${b >= 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c} = 0:**

[formula]x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a[/formula]

**Results:**
‚Ä¢ x‚ÇÅ = ${x1.toFixed(2)}
‚Ä¢ x‚ÇÇ = ${x2.toFixed(2)}`;
    } else if (discriminant === 0) {
      const x = -b / (2 * a);
      return `**Solution:** One repeated root: x = ${x.toFixed(2)}`;
    } else {
      return `**Solution:** Two complex roots (discriminant = ${discriminant})`;
    }
  }
  return "I can solve quadratic equations! Please format like: x¬≤ + 5x + 6 = 0";
}

// ========================
// Photosynthesis
// ========================
function explainPhotosynthesis() {
  return `**Photosynthesis Explained:**

Plants convert light energy into chemical energy.

[formula]6CO‚ÇÇ + 6H‚ÇÇO + Light Energy ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ[/formula]

**Process:**
1Ô∏è‚É£ **Light-dependent reactions** - Produce ATP & NADPH
2Ô∏è‚É£ **Calvin Cycle** - Fixes CO‚ÇÇ into glucose

**Key Factors:**
‚Ä¢ Light intensity
‚Ä¢ CO‚ÇÇ concentration
‚Ä¢ Temperature
‚Ä¢ Water availability

**Importance:** Produces oxygen and food for most life on Earth.`;
}

// ========================
// Quick Message
// ========================
function sendQuickMessage(msg) {
  document.getElementById('messageInput').value = msg;
  sendMessage();
}

// ========================
// Clear Chat
// ========================
function clearChat() {
  if (!confirm('Clear all chat history?')) return;
  const container = document.getElementById('messagesContainer');
  container.innerHTML = `
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-icon">üéì</div>
      <h2 class="welcome-title">Welcome to StudyHub AI</h2>
      <p class="welcome-subtitle">Your intelligent academic companion for learning, problem-solving, and research support</p>
      
      <div class="quick-prompts">
        <div class="prompt-card" onclick="sendQuickMessage('Help me solve a quadratic equation')">
          <div class="prompt-icon">üßÆ</div>
          <div class="prompt-title">Math & Science</div>
          <div class="prompt-desc">Solve equations and explain formulas</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('Help me write an essay about climate change')">
          <div class="prompt-icon">‚úçÔ∏è</div>
          <div class="prompt-title">Writing Support</div>
          <div class="prompt-desc">Essays, reports, and citations</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('What are effective study techniques?')">
          <div class="prompt-icon">üìñ</div>
          <div class="prompt-title">Study Strategies</div>
          <div class="prompt-desc">Learn effective study methods</div>
        </div>
        <div class="prompt-card" onclick="sendQuickMessage('Explain photosynthesis')">
          <div class="prompt-icon">üî¨</div>
          <div class="prompt-title">Concept Explanations</div>
          <div class="prompt-desc">Understand complex topics</div>
        </div>
      </div>
    </div>
    <div class="message bot" style="display:none;">
      <div class="message-avatar bot-msg-avatar">ü§ñ</div>
      <div class="message-content">
        <div class="typing-indicator" id="typingIndicator">
          <span class="typing-text">AI is typing</span>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  `;
  messageHistory = [];
}
</script>
</body>
</html>
