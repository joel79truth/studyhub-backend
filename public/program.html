<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programs ‚Äì StudyHub LUANAR</title>
<link rel="stylesheet" href="style.css">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: linear-gradient(rgba(15, 23, 42, 0), rgba(30, 41, 59, 0)),
                url('https://images.pexels.com/photos/6216870/pexels-photo-6216870.jpeg?auto=compress&cs=tinysrgb&dpr=3&h=750&w=1260') no-repeat center center fixed;
    background-size: cover;
    color: #ffffff50;
    min-height: 100vh;
    padding-bottom: 40px;
  }

  /* Header */
  header {
    text-align: center;
    padding: 30px 20px;
    background: rgba(37, 180, 32, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  h1 { 
    margin: 0; 
    font-size: 2rem;
    background: linear-gradient(90deg, #ffffff, #fbfbfc, #f3f5f7);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* Container */
  .container { 
    max-width: 1200px; 
    margin: 30px auto; 
    padding: 0 20px; 
  }

  /* Info Banner */
  .info-banner {
    text-align: center;
    margin: 20px auto 30px;
    max-width: 600px;
    background: rgba(59, 130, 246, 0.15);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-radius: 15px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    font-size: 0.9rem;
    color: #2b2c31;
    font-weight: 500;
    line-height: 1.6;
  }

  /* Search Bar */
  .search-bar { 
    max-width: 500px; 
    margin: 0 auto 30px; 
    position: relative; 
  }

  .search-bar input {
    width: 100%;
    padding: 15px 20px 15px 50px;
    border-radius: 50px;
    border: 2px solid rgba(59, 130, 246, 0.3);
    outline: none;
    font-size: 15px;
    background: rgba(30, 41, 59, 0.8);
    backdrop-filter: blur(10px);
    color: #fff;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .search-bar input:focus {
    border-color: rgba(59, 130, 246, 0.6);
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
  }

  .search-bar input::placeholder {
    color: #94a3b8;
  }

  .search-bar::before {
    content: 'üîç';
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    pointer-events: none;
  }

  /* Program Cards Grid */
  #programList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
    padding: 0;
  }

  .program-card {
    background: rgba(30, 41, 59, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px 25px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(59, 130, 246, 0.2);
    text-align: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  }

  .program-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .program-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(59, 130, 246, 0.3);
    border-color: rgba(59, 130, 246, 0.5);
  }

  .program-card:hover::before {
    opacity: 1;
  }

  .program-card h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #fff;
    font-weight: 600;
    line-height: 1.4;
    word-wrap: break-word;
  }

  /* Unread Badge */
  .unread-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    font-size: 0.75rem;
    font-weight: bold;
    min-width: 24px;
    height: 24px;
    padding: 0 6px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
  }

  /* Back Home Button */
  .back-home-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #050505, #151616);
    color: white;
    text-decoration: none;
    border-radius: 50%;
    font-size: 22px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    z-index: 1000;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .back-home-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
  }

  /* Profile Button */
  #youButton {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1000;
  }

  #youButton .profile-picture {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #3b82f6;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s;
  }

  #youButton .profile-picture:hover {
    transform: scale(1.1);
  }

  #youButton .btn-label {
    margin-top: 5px;
    font-size: 12px;
    font-weight: 600;
    color: #60a5fa;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  /* Action Menu */
  .action-menu {
    position: fixed;
    top: 120px;
    right: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 12px;
    cursor: grab;
    z-index: 999;
    user-select: none;
  }

  .action-menu.dragging {
    cursor: grabbing;
  }

  /* Toggle Button */
  .toggle-btn {
    width: 45px;
    height: 45px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #3b82f6);
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .toggle-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6);
  }

  /* Actions Container */
  .actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0;
    transform: translateX(60px);
    transition: all 0.3s;
    pointer-events: none;
  }

  .action-menu.active .actions {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }

  /* Action Buttons */
  .actions a {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 20px;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s;
  }

  .actions a:hover {
    transform: scale(1.1);
  }

  .actions a[title="Upload Notes"] { 
    background: linear-gradient(135deg, #4f46e5, #3b82f6); 
  }
  .actions a[title="Request Notes"] { 
    background: linear-gradient(135deg, #9333ea, #a855f7); 
  }
  .actions a[title="Wisdom"] { 
    background: linear-gradient(135deg, #f59e0b, #facc15); 
  }
  .actions a[title="Video Lessons"] { 
    background: linear-gradient(135deg, #10b981, #34d399); 
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
    font-size: 1.1rem;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    header {
      padding: 20px 15px;
    }

    h1 {
      font-size: 1.5rem;
    }

    .container {
      padding: 0 15px;
      margin: 20px auto;
    }

    .info-banner {
      font-size: 0.85rem;
      padding: 12px 15px;
      margin: 15px auto 25px;
    }

    .search-bar {
      margin-bottom: 25px;
    }

    .search-bar input {
      padding: 13px 15px 13px 45px;
      font-size: 14px;
    }

    .search-bar::before {
      left: 15px;
      font-size: 16px;
    }

    #programList {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
    }

    .program-card {
      padding: 25px 20px;
    }

    .program-card h3 {
      font-size: 1rem;
    }

    .back-home-btn {
      width: 45px;
      height: 45px;
      font-size: 20px;
      top: 15px;
      left: 15px;
    }

    #youButton {
      top: 15px;
      right: 15px;
    }

    #youButton .profile-picture {
      width: 45px;
      height: 45px;
    }

    #youButton .btn-label {
      font-size: 11px;
    }

    .action-menu {
      top: 100px;
      right: 15px;
    }

    .toggle-btn,
    .actions a {
      width: 42px;
      height: 42px;
      font-size: 18px;
    }
  }

  @media (max-width: 480px) {
    h1 {
      font-size: 1.3rem;
    }

    .info-banner {
      font-size: 0.8rem;
      padding: 10px 12px;
    }

    #programList {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .program-card {
      padding: 20px 15px;
    }

    .program-card h3 {
      font-size: 0.95rem;
    }

    .back-home-btn {
      width: 40px;
      height: 40px;
      font-size: 18px;
      top: 12px;
      left: 12px;
    }

    #youButton {
      top: 12px;
      right: 12px;
    }

    #youButton .profile-picture {
      width: 40px;
      height: 40px;
      border-width: 2px;
    }

    #youButton .btn-label {
      font-size: 10px;
    }

    .action-menu {
      top: 90px;
      right: 12px;
    }

    .toggle-btn,
    .actions a {
      width: 40px;
      height: 40px;
      font-size: 16px;
    }

    .unread-badge {
      top: 10px;
      right: 10px;
      font-size: 0.7rem;
      min-width: 22px;
      height: 22px;
    }
  }

  /* Disable animations on mobile for performance */
  @media (max-width: 768px) {
    * {
      animation: none !important;
      transition: none !important;
    }



    /* Keep only essential transitions */
    @media (max-width: 768px) {
  * {
    animation: none !important;
    transition: none !important;
  }
  
  .program-card,
  .toggle-btn,
  .actions a,
  .back-home-btn,
  #youButton .profile-picture {
    transition: transform 0.15s ease !important;
  }
}

  }

@media (max-width: 480px) {
  body {
    background: url('https://images.pexels.com/photos/6216870/pexels-photo-6216870.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=400&w=600') no-repeat center center fixed;
    background-size: cover;
  }
}
@media (max-width: 768px) {
  header, 
  .program-card, 
  .search-bar, 
  .info-banner {
    backdrop-filter: none !important;
    box-shadow: none !important;
    border: none !important;
  }
}
@media (max-width: 768px) {
  .program-card:hover {
    transform: none;
    box-shadow: none;
    border-color: initial;
  }
  .program-card::before {
    opacity: 0 !important;
  }
}

@media (max-width: 768px) {
  #youButton .btn-label {
    text-shadow: none;
  }
}

</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RP8NY538W2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RP8NY538W2');
</script>
</script>

</head>
<body>

<a href="index.html" class="back-home-btn" aria-label="Back to Home">üè†</a>

<header>
  <h1>LUANAR Programs</h1>
</header>

<div class="profile-container" id="youButton">
  <a href="profile.html">
    <img id="youProfilePic" 
         src="https://cdn-icons-png.flaticon.com/512/847/847969.png" 
         alt="Profile Picture" 
         class="profile-picture">
  </a>
  <div class="btn-label">You</div>
</div>

<div class="action-menu" id="actionMenu">
  <button class="toggle-btn" id="menuToggle">&lt;</button>
  <div class="actions" id="actions">
    <a href="upload.html" title="Upload Notes">üì§</a>
    <a href="request.html" title="Request Notes">üì©</a>
    <a href="wisdom.html" title="Wisdom">üí°</a>
    <a href="videolesson.html" title="Video Lessons">üé•</a>
  </div>
</div>

<div class="container">
  <div class="info-banner">
    üí° Have notes to share? Upload them or request others' notes!
  </div>

  <div class="search-bar">
    <input type="text" id="programSearch" placeholder="Search programs..." autocomplete="off">
  </div>

  <div id="programList"></div>
</div>

<script>
let allPrograms = [];
let programCounts = {};

// Normalize program names for comparison
function normalizeName(name) {
  return name.trim().toLowerCase();
}

// Merge similar program names to avoid duplicate cards
function mergeSimilarPrograms(files) {
  const mergedCounts = {};

  files.forEach(f => {
    if (!f.program) return;

    // Normalize name: lowercase, remove common filler words & punctuation
    const cleaned = f.program
      .toLowerCase()
      .replace(/\b(in|of|and|the|at|on|for|by|to)\b/g, "")
      .replace(/[^a-z\s]/g, "")
      .replace(/\s+/g, " ")
      .trim();

    // If a similar program already exists, increment its count
    const existingKey = Object.keys(mergedCounts).find(k => {
      const kClean = k.toLowerCase().replace(/\b(in|of|and|the|at|on|for|by|to)\b/g, "").replace(/[^a-z\s]/g, "").replace(/\s+/g, " ").trim();
      return kClean === cleaned;
    });

    if (existingKey) {
      mergedCounts[existingKey]++;
    } else {
      mergedCounts[f.program.trim()] = 1;
    }
  });

  return mergedCounts;
}


// Load programs from backend
async function loadPrograms() {
  try {
    const res = await fetch("/api/metadata");
    const data = await res.json();
    const files = Array.isArray(data) ? data : (data.files || []);

    programCounts = mergeSimilarPrograms(files);
    allPrograms = Object.keys(programCounts);

    displayPrograms(allPrograms, programCounts);
  } catch (err) {
    console.error("Failed to load programs:", err);
    displayPrograms([], {});
  }
}

// Display program cards
function displayPrograms(programs, counts) {
  const container = document.getElementById("programList");
  container.innerHTML = "";

  if (!programs.length) {
    container.innerHTML = '<div class="empty-state">üìö No programs uploaded yet. Be the first to upload!</div>';
    return;
  }

  const seenData = JSON.parse(localStorage.getItem("programSeen") || "{}");

  programs.forEach(p => {
    const card = document.createElement("div");
    card.className = "program-card";
    card.addEventListener("click", () => openProgram(p, counts[p]));

    const title = document.createElement("h3");
    title.textContent = p;
    card.appendChild(title);

    // Unread badge
    const lastSeen = seenData[p] || 0;
    const unread = Math.max(0, (counts[p] || 0) - lastSeen);

    if (unread > 0) {
      const badge = document.createElement("div");
      badge.className = "unread-badge";
      badge.textContent = unread;
      card.appendChild(badge);
    }

    container.appendChild(card);
  });
}

// Mark program as seen and open detail
function openProgram(program, currentCount) {
  const seenData = JSON.parse(localStorage.getItem("programSeen") || "{}");
  seenData[program] = currentCount;
  localStorage.setItem("programSeen", JSON.stringify(seenData));
  window.location.href = `program-detail.html?program=${encodeURIComponent(program)}`;
}

// Debounced search filter
let debounceTimer;
document.getElementById("programSearch").addEventListener("input", function() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const query = normalizeName(this.value);
    const filtered = allPrograms.filter(p => normalizeName(p).includes(query));
    displayPrograms(filtered, programCounts);
  }, 200);
});

// Load saved profile picture
window.addEventListener("load", () => {
  const savedPic = localStorage.getItem("userProfilePic");
  if (savedPic) document.getElementById("youProfilePic").src = savedPic;
});

// Action menu toggle
const actionMenu = document.querySelector(".action-menu");
const toggleBtn = document.querySelector(".toggle-btn");

toggleBtn.addEventListener("click", () => {
  actionMenu.classList.toggle("active");
  toggleBtn.textContent = actionMenu.classList.contains("active") ? ">" : "<";
});

// Draggable support
let isDragging = false, offsetX, offsetY;

actionMenu.addEventListener("mousedown", e => {
  if (e.target === toggleBtn || e.target.closest('.actions')) return;
  isDragging = true;
  const rect = actionMenu.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;
  actionMenu.classList.add("dragging");
  actionMenu.style.transition = 'none';
});

document.addEventListener("mousemove", e => {
  if (!isDragging) return;
  let x = e.clientX - offsetX;
  let y = e.clientY - offsetY;
  x = Math.max(0, Math.min(x, window.innerWidth - actionMenu.offsetWidth));
  y = Math.max(0, Math.min(y, window.innerHeight - actionMenu.offsetHeight));
  actionMenu.style.left = x + "px";
  actionMenu.style.top = y + "px";
  actionMenu.style.right = "auto";
});

document.addEventListener("mouseup", () => {
  if (isDragging) {
    isDragging = false;
    actionMenu.classList.remove("dragging");
    actionMenu.style.transition = '';
  }
});

// Touch support for mobile dragging
let ticking = false;

actionMenu.addEventListener("touchmove", e => {
  if (!touchStartX || ticking) return;
  e.preventDefault();
  const touch = e.touches[0];
  ticking = true;
  requestAnimationFrame(() => {
    let x = touch.clientX - touchStartX;
    let y = touch.clientY - touchStartY;
    x = Math.max(0, Math.min(x, window.innerWidth - actionMenu.offsetWidth));
    y = Math.max(0, Math.min(y, window.innerHeight - actionMenu.offsetHeight));
    actionMenu.style.left = x + "px";
    actionMenu.style.top = y + "px";
    actionMenu.style.right = "auto";
    ticking = false;
  });
});

// Initial load
loadPrograms();
</script>

</body>
</html>
