<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile ‚Äì StudyHub LUANAR</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }

body, html {
  min-height: 100%;
  background: linear-gradient(135deg, #0c0c0e 0%, #2c2830 100%);
  color: #fff;
  padding: 20px 10px;
  overflow-x: hidden;
}

/* Top Navigation Bar */
.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1000;
  box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

.top-nav h1 {
  font-size: 18px;
  color: #60a5fa;
  margin: 0;
}

.nav-icons {
  display: flex;
  gap: 15px;
}

.nav-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(59, 130, 246, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.nav-icon:hover {
  background: rgba(59, 130, 246, 0.4);
  transform: scale(1.1);
}

.nav-icon img {
  width: 18px;
  height: 18px;
  filter: invert(1);
}

/* Profile Container */
.profile-container {
  background: rgba(68, 67, 67, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 30px 20px;
  max-width: 600px;
  margin: 80px auto 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Profile Header */
.profile-header {
  text-align: center;
  margin-bottom: 25px;
}

.profile-pic-wrapper {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 15px;
}

.profile-picture {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #60a5fa;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 8px 24px rgba(96, 165, 250, 0.4);
}

.profile-picture:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 32px rgba(96, 165, 250, 0.6);
}

.edit-pic-badge {
  position: absolute;
  bottom: 5px;
  right: 5px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #60a5fa;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.edit-pic-badge::before {
  content: 'üì∑';
  font-size: 16px;
}

.user-name {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 5px;
}

.user-email {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 15px;
}

.edit-btn {
  background: linear-gradient(135deg, #0a0a0a, #000000);
  color: #fff;
  border: none;
  padding: 10px 24px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  font-size: 14px;
}

.edit-btn:hover {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6);
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 25px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 15px 10px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: #60a5fa;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Edit Profile Form */
.edit-profile-form {
  display: none;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 25px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.form-group {
  margin-bottom: 15px;
}

.form-label {
  display: block;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 8px;
  font-weight: 600;
}

.edit-profile-form input {
  width: 100%;
  padding: 12px 15px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  font-size: 14px;
  transition: all 0.3s ease;
}

.edit-profile-form input:focus {
  outline: none;
  border-color: #60a5fa;
  background: rgba(255, 255, 255, 0.15);
}

.edit-profile-form input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.save-btn, .cancel-btn {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
}

.save-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.save-btn:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
}

.cancel-btn {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.cancel-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Quick Actions */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 25px;
}

.action-card {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.action-card:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.action-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.action-info {
  flex: 1;
}

.action-title {
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 2px;
}

.action-desc {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.6);
}

/* Files Section */
.files-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
}

.files-count {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 12px;
  border-radius: 20px;
}

.files-list {
  max-height: 400px;
  overflow-y: auto;
  padding-right: 5px;
}

.files-list::-webkit-scrollbar {
  width: 6px;
}

.files-list::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.files-list::-webkit-scrollbar-thumb {
  background: rgba(96, 165, 250, 0.5);
  border-radius: 10px;
}

.file-card {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.file-card:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateX(5px);
}

.file-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.file-info {
  flex: 1;
  min-width: 0;
}

.file-name {
  font-weight: 600;
  color: #fff;
  font-size: 14px;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-meta {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
}

.file-link {
  background: linear-gradient(135deg, #080808, #050505);
  padding: 8px 16px;
  border-radius: 10px;
  text-decoration: none;
  color: #fff;
  font-weight: 600;
  font-size: 12px;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.file-link:hover {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  transform: scale(1.05);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.6);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

.empty-subtext {
  font-size: 13px;
  opacity: 0.7;
}

/* Logout Button */
.logout-section {
  margin-top: 25px;
  text-align: center;
}

.logout-btn {
  background: rgba(239, 68, 68, 0.2);
  color: #fff;
  border: 1px solid rgba(239, 68, 68, 0.3);
  padding: 12px 30px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
}

.logout-btn:hover {
  background: rgba(239, 68, 68, 0.3);
  border-color: rgba(239, 68, 68, 0.5);
}

/* Mobile Responsiveness */
@media (max-width: 600px) {
  body {
    padding: 10px 5px;
  }

  .profile-container {
    padding: 25px 15px;
    margin: 70px auto 15px;
  }

  .top-nav h1 {
    font-size: 16px;
  }

  .nav-icons {
    gap: 10px;
  }

  .nav-icon {
    width: 28px;
    height: 28px;
  }

  .nav-icon img {
    width: 16px;
    height: 16px;
  }

  .profile-picture, .profile-pic-wrapper {
    width: 100px;
    height: 100px;
  }

  .user-name {
    font-size: 20px;
  }

  .user-email {
    font-size: 13px;
  }

  .stats-grid {
    gap: 10px;
  }

  .stat-card {
    padding: 12px 8px;
  }

  .stat-value {
    font-size: 20px;
  }

  .stat-label {
    font-size: 10px;
  }

  .quick-actions {
    grid-template-columns: 1fr;
  }

  .section-title {
    font-size: 16px;
  }

  .file-card {
    flex-wrap: wrap;
  }

  .file-link {
    width: 100%;
    text-align: center;
    margin-top: 10px;
  }
}

@media (max-width: 400px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }

  .form-actions {
    flex-direction: column;
  }

  .file-name {
    font-size: 13px;
  }

  .file-meta {
    font-size: 11px;
  }
}
</style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RP8NY538W2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RP8NY538W2');
</script>
</head>
<body>

<!-- Top Navigation -->
<div class="top-nav">
  <a href="javascript:history.back()" class="nav-icon" title="Back">
    <img src="https://cdn-icons-png.flaticon.com/512/271/271220.png" alt="Back">
  </a>
  <h1>My Profile</h1>
  <div class="nav-icons">
    <a href="chat.html" class="nav-icon" title="Messages">
      <img src="https://cdn-icons-png.flaticon.com/512/3670/3670373.png" alt="Messages">
    </a>
    <a href="friend_requests.html" class="nav-icon" title="Friend Requests">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="Requests">
    </a>
  </div>
</div>

<div class="profile-container">
  
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-pic-wrapper">
      <img src="https://www.w3schools.com/howto/img_avatar.png" alt="Profile Picture" id="profilePic" class="profile-picture">
      <div class="edit-pic-badge" id="changePicBtn"></div>
    </div>
    <input type="file" id="uploadPic" accept="image/*" style="display:none;">
    
    <div class="user-name" id="userName">Loading...</div>
    <div class="user-email" id="userEmail"></div>
    
    <button class="edit-btn" id="editProfileBtn">‚úèÔ∏è Edit Profile</button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="filesCount">0</div>
      <div class="stat-label">Files</div>
    </div>
    
   

  <!-- Edit Profile Form -->
  <form class="edit-profile-form" id="editProfileForm">
    <div class="form-group">
      <label class="form-label">Display Name</label>
      <input type="text" id="editName" placeholder="Enter your name" required>
    </div>
    <div class="form-group">
      <label class="form-label">Email Address</label>
      <input type="email" id="editEmail" placeholder="Enter your email" required>
    </div>
    <div class="form-actions">
      <button type="submit" class="save-btn">üíæ Save Changes</button>
      <button type="button" class="cancel-btn" id="cancelEditBtn">‚úñÔ∏è Cancel</button>
    </div>
  </form>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <div class="action-card" onclick="window.location.href='upload.html'">
      <div class="action-icon" style="background: linear-gradient(135deg, #0c0c0c, #070707);">
        üì§
      </div>
      <div class="action-info">
        <div class="action-title">Upload Notes</div>
        <div class="action-desc">Share your knowledge</div>
      </div>
    </div>

    <div class="action-card" onclick="window.location.href='videolesson.html'">
      <div class="action-icon" style="background: linear-gradient(135deg, #0e0d0d, #080808);">
        ‚ñ∂Ô∏è
      </div>
      <div class="action-info">
        <div class="action-title">Video Lessons</div>
        <div class="action-desc">Watch tutorials</div>
      </div>
    </div>

    <div class="action-card" onclick="window.location.href='wisdom.html'">
      <div class="action-icon" style="background: linear-gradient(135deg, #0a0a0a, #0e0d0d);">
        üí°
      </div>
      <div class="action-info">
        <div class="action-title">Wisdom</div>
        <div class="action-desc">Get inspired</div>
      </div>
    </div>

    <div class="action-card" onclick="window.location.href='friend_requests.html'">
      <div class="action-icon" style="background: linear-gradient(135deg, #95a1ca, #7999f0);">
        üë•
      </div>
      <div class="action-info">
        <div class="action-title">Friend Requests</div>
        <div class="action-desc">Manage connections</div>
      </div>
    </div>
  </div>

  <!-- Files Section -->
  <div class="files-section">
    <div class="section-header">
      <h2 class="section-title">üìÅ My Files</h2>
      <span class="files-count" id="filesCountBadge">0 files</span>
    </div>
    <div class="files-list" id="filesList">
      <div class="empty-state">
        <div class="empty-icon">üìÑ</div>
        <div class="empty-text">Loading files...</div>
      </div>
    </div>
  </div>

  <!-- Logout Section -->
  <div class="logout-section">
    <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, updateProfile, updateEmail } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtK_FW9fIOihmnECEngkElA2QCsoRYUA0",
  authDomain: "studyhub-backend.firebaseapp.com",
  projectId: "studyhub-backend",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Elements
const profilePic = document.getElementById("profilePic");
const userNameDiv = document.getElementById("userName");
const userEmailDiv = document.getElementById("userEmail");
const uploadInput = document.getElementById("uploadPic");
const changePicBtn = document.getElementById("changePicBtn");
const editProfileBtn = document.getElementById("editProfileBtn");
const editProfileForm = document.getElementById("editProfileForm");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const editNameInput = document.getElementById("editName");
const editEmailInput = document.getElementById("editEmail");
const filesList = document.getElementById("filesList");
const filesCount = document.getElementById("filesCount");
const filesCountBadge = document.getElementById("filesCountBadge");
const logoutBtn = document.getElementById("logoutBtn");

// Load cached profile picture instantly
const cachedPic = localStorage.getItem("userProfilePic");
if (cachedPic) profilePic.src = cachedPic;

// Auth check
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    const savedPic = localStorage.getItem("userProfilePic");
    localStorage.clear();
    if (savedPic) localStorage.setItem("userProfilePic", savedPic);
    window.location.replace("login.html");
    return;
  }

  profilePic.src = user.photoURL || localStorage.getItem("userProfilePic") || "https://www.w3schools.com/howto/img_avatar.png";
  userNameDiv.textContent = user.displayName || "No Name";
  userEmailDiv.textContent = user.email;

  try {
    const token = await user.getIdToken();
    const response = await fetch("/api/metadata", { headers: { "Authorization": "Bearer " + token } });
    const data = await response.json();
    const userFiles = data.filter(f => f.email === user.email);
    
    filesCount.textContent = userFiles.length;
    filesCountBadge.textContent = `${userFiles.length} file${userFiles.length !== 1 ? 's' : ''}`;
    
    if (userFiles.length === 0) {
      filesList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìÑ</div>
          <div class="empty-text">No files yet</div>
          <div class="empty-subtext">Upload your first note to get started!</div>
        </div>
      `;
    } else {
      filesList.innerHTML = userFiles.map(f => `
        <div class="file-card">
          <div class="file-icon">üìÑ</div>
          <div class="file-info">
            <div class="file-name">${f.filename}</div>
            <div class="file-meta">${f.subject} ‚Ä¢ Semester ${f.semester}</div>
          </div>
          <a href="${f.url}" target="_blank" class="file-link">View</a>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error(err);
    filesList.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚ö†Ô∏è</div>
        <div class="empty-text">Failed to load files</div>
        <div class="empty-subtext">Please try again later</div>
      </div>
    `;
  }
});

// Profile picture change
profilePic.addEventListener("click", () => uploadInput.click());
changePicBtn.addEventListener("click", () => uploadInput.click());

uploadInput.addEventListener("change", function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const newPhoto = e.target.result;
      profilePic.src = newPhoto;
      localStorage.setItem("userProfilePic", newPhoto);
      if (auth.currentUser) updateProfile(auth.currentUser, { photoURL: newPhoto });
    };
    reader.readAsDataURL(file);
  }
});

// Edit profile toggle
editProfileBtn.addEventListener("click", () => {
  editProfileForm.style.display = "block";
  editNameInput.value = auth.currentUser?.displayName || "";
  editEmailInput.value = auth.currentUser?.email || "";
});

// Cancel edit
cancelEditBtn.addEventListener("click", () => {
  editProfileForm.style.display = "none";
});

// Save changes
editProfileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    await updateProfile(user, { displayName: editNameInput.value });
    if (user.email !== editEmailInput.value) {
      await updateEmail(user, editEmailInput.value);
    }
    userNameDiv.textContent = editNameInput.value;
    userEmailDiv.textContent = editEmailInput.value;
    alert("‚úÖ Profile updated successfully!");
    editProfileForm.style.display = "none";
  } catch (err) {
    console.error(err);
    alert("‚ùå Failed to update profile. Please try again.");
  }
});

// Logout
logoutBtn.addEventListener("click", async () => {
  if (confirm("Are you sure you want to logout?")) {
    try {
      await signOut(auth);
      localStorage.clear();
      window.location.replace("login.html");
    } catch (error) {
      console.error("Logout failed:", error);
      alert("‚ùå Logout failed. Please try again.");
    }
  }
});
</script>
</body>
</html>