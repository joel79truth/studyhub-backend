<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub - Classroom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #080808 0%, #241236 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .container {
            background: rgb(0, 0, 0);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(42, 44, 44, 0.966);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            
            .container {
                border-radius: 0;
                height: 100vh;
                max-height: 100vh;
            }
        }

        .form-container {
            padding: 40px;
            max-height: 100vh;
            overflow-y: auto;
        }

        @media (max-width: 480px) {
            .form-container {
                padding: 20px;
            }
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 24px;
            }
        }

        h2 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 22px;
        }

        @media (max-width: 480px) {
            h2 {
                font-size: 20px;
            }
        }

        h3 {
            color: #333;
            font-size: 18px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .error {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 13px;
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        /* Dashboard Styles */
        .dashboard {
            display: flex;
            height: 100vh;
            max-height: 800px;
        }

        @media (max-width: 480px) {
            .dashboard {
                max-height: 100vh;
            }
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            transition: transform 0.3s;
            position: relative;
            transform: translateX(-250px);
            overflow-y: auto;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .sidebar-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-btn:hover {
            background: #415b76;
        }

        .sidebar-btn.active {
            background: #667eea;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f6fa;
        }

        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h2 {
            margin: 0;
            color: #667eea;
            font-size: 20px;
        }

        .toggle-sidebar-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .lecturers-list {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .lecturers-list h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .lecturer-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lecturer-item::before {
            content: 'üë®‚Äçüè´';
            font-size: 16px;
        }

        .messages-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .message-type {
            color: #667eea;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .message-time {
            color: #999;
            font-size: 12px;
        }

        .message-text {
            color: #333;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .message-attachment {
            margin-top: 8px;
        }

        .attachment-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            transition: background 0.3s;
        }

        .attachment-link:hover {
            background: #5568d3;
        }

        .message-input-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .message-input-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group select {
            max-width: 200px;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e9ebef;
            color: #333;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #ddd;
        }

        .file-input {
            display: none;
        }

        .file-name {
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }

        .chat-icon-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .chat-label {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            white-space: nowrap;
        }

        .waiting-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .waiting-message h2 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .class-list-item {
            background: #34495e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 13px;
        }

        .class-list-item:hover {
            background: #415b76;
        }

        .class-list-item.active {
            background: #667eea;
        }

      .call-buttons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
}

.call-btn-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.call-btn {
  width: 50px;
  height: 50px;
  border-radius: 60%;
  border: none;
  cursor: pointer;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, background 0.3s;
}

.call-btn:hover {
  transform: scale(1.1);
}

.video-call-btn {
  background: #030303;
  color: white;
}

.video-call-btn:hover {
  background: #229954;
}

.voice-call-btn {
  background: #000a11;
  color: white;
}

.voice-call-btn:hover {
  background: #2980b9;
}

.chat-btn {
  background: #000000;
  color: white;
}

.chat-btn:hover {
  background: #ca6f1e;
}

.call-label {
  margin-top: 6px;
  font-size: 13px;
  color: #333;
  text-align: center;
}


@media (max-width: 480px) {
    .call-buttons {
        flex-direction: row !important;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
}


        .notification-permission {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .notification-permission button {
            background: #ffc107;
            color: #856404;
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 1000;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .chat-icon-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .chat-label {
                font-size: 10px;
                bottom: -25px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px 20px;
            }

            .header h2 {
                font-size: 16px;
            }

            .toggle-sidebar-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .content-area {
                padding: 15px;
            }

            .messages-container {
                padding: 15px;
                margin-bottom: 15px;
                max-height: 300px;
            }

            .message-input-section {
                padding: 15px;
            }

            .message-input-section h3 {
                font-size: 16px;
            }

            .input-group {
                flex-direction: column;
            }

            .input-group select {
                max-width: 100%;
            }

            button {
                padding: 12px 20px; 
                font-size: 14px;
            }

            input, select, textarea {
                padding: 10px 14px;
                font-size: 14px;
            }

            .call-buttons {
                flex-direction: column;
            }

            .notification-permission {
                flex-direction: column;
                align-items: flex-start;
            }

            .notification-permission button {
                width: 100%;
            }
        }


     .attachment-menu {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    padding: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
}
.attachment-menu div {
    padding: 5px 10px;
    cursor: pointer;
}
.attachment-menu div:hover {
    background: #f0f0f0;
}


    </style>

 <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0LTZS1S9W6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-0LTZS1S9W6');
  </script>

</head>
<body>
    <div class="container">
        <!-- Role Selection Screen -->
        <div id="roleSelection" class="form-container">
            <h1>üìö Welcome to StudyHub</h1>
            <p class="subtitle">Please select your role to continue</p>
            
            <div class="form-group">
                <button onclick="selectRole('lecturer')">I am a Lecturer</button>
            </div>
            <div class="form-group">
                <button onclick="selectRole('student')" class="btn-secondary">I am a Student</button>
            </div>
        </div>

        <!-- Lecturer Security Code Screen -->
        <div id="lecturerSecurity" class="form-container hidden">
            <h2>üîê Lecturer Verification</h2>
            <p class="subtitle">Please enter the security code to continue</p>
            
            <div class="form-group">
                <label for="securityCode">Security Code</label>
                <input type="password" id="securityCode" placeholder="Enter security code">
                <div id="securityError" class="error hidden">Invalid security code!</div>
            </div>
            
            <button onclick="verifySecurityCode()">Verify</button>
            <button onclick="goBack()" class="btn-secondary">Back</button>
        </div>

        <!-- Lecturer Create Classroom Screen -->
        <div id="createClassroom" class="form-container hidden">
            <h2>üè´ Create Classroom</h2>
            <p class="subtitle">Set up your virtual classroom</p>
            
            <div class="form-group">
                <label for="programName">Program Name *</label>
                <input type="text" id="programName" placeholder="e.g., Diploma in Computer Science">
                <div id="programError" class="error hidden">Program must start with 'diploma', 'bachelor', or 'basics'</div>
            </div>

            <div class="form-group">
                <label for="semester">Semester *</label>
                <select id="semester">
                    <option value="">Select semester</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>
            </div>

            <div class="form-group">
                <label for="lecturerEmail">Your Email *</label>
                <input type="email" id="lecturerEmail" placeholder="lecturer@university.edu">
            </div>
            
            <button onclick="createClassroom()">Create Classroom</button>
            <button onclick="goBack()" class="btn-secondary">Back</button>
        </div>

        <!-- Student Join Screen -->
        <div id="studentJoin" class="form-container hidden">
            <h2>üë®‚Äçüéì Join Classroom</h2>
            <p class="subtitle">Enter your details to join the class</p>
            
            <div class="form-group">
                <label for="studentProgram">Program Name *</label>
                <input type="text" id="studentProgram" placeholder="e.g., Diploma in Computer Science">
                <div id="studentProgramError" class="error hidden">Program must start with 'diploma', 'bachelor', or 'basics'</div>
            </div>

            <div class="form-group">
                <label for="studentSemester">Semester *</label>
                <select id="studentSemester">
                    <option value="">Select semester</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                    <option value="4">Semester 4</option>
                    <option value="5">Semester 5</option>
                    <option value="6">Semester 6</option>
                    <option value="7">Semester 7</option>
                    <option value="8">Semester 8</option>
                </select>
            </div>

            <div class="form-group">
                <label for="studentName">Full Name *</label>
                <input type="text" id="studentName" placeholder="Enter your full name">
            </div>
            
            <button onclick="joinClassroom()">Join Classroom</button>
            <button onclick="goBack()" class="btn-secondary">Back</button>
        </div>

        <!-- Lecturer Dashboard -->
        <div id="lecturerDashboard" class="dashboard hidden">
            <div class="sidebar" id="sidebar">
                <h3>üìã Menu</h3>
                <button class="sidebar-btn" onclick="showAddClassForm()">‚ûï Add Class</button>
                <div id="classList" style="margin-bottom: 20px;"></div>
                <button class="sidebar-btn" onclick="viewStudents()">üë• View Students</button>
                <button class="sidebar-btn" onclick="viewAnalytics()">üìä Analytics</button>
                <button class="sidebar-btn" onclick="settings()">‚öôÔ∏è Settings</button>
                <button class="sidebar-btn" onclick="logout()" style="background: #e74c3c; margin-top: 20px;">üö™ Logout</button>
            <button onclick="
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('active');
">
  √ó Close
</button>

            
            </div>

            <div class="main-content">
                <div class="header">
                    <h2 id="dashboardTitle">Loading...</h2>
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
                </div>

                <div class="content-area">
                    <div class="lecturers-list">
                        <h4>üë®‚Äçüè´ Lecturers in this Classroom</h4>
                        <div id="lecturersList">
                            <p style="color: #999; font-size: 13px;">Loading...</p>
                        </div>
                    </div>
<div class="call-buttons">
  <div class="call-btn-wrapper">
    <button class="call-btn video-call-btn">üìπ</button>
    <div class="call-label">Video</div>
  </div>

  <div class="call-btn-wrapper">
    <button class="call-btn voice-call-btn">üìû</button>
    <div class="call-label">Voice</div>
  </div>

  <div class="call-btn-wrapper">
    <button class="call-btn chat-btn">üí¨</button>
    <div class="call-label">Chat</div>
  </div>
</div>




                    <div class="messages-container">
                        <h3 style="margin-bottom: 15px; color: #333;">üì¢ Announcements & Assignments</h3>
                        <div id="messagesList">
                            <p style="color: #999; text-align: center; padding: 20px;">No messages yet. Create your first announcement or assignment below.</p>
                        </div>
                    </div>

                    <div class="message-input-section">
                        <h3>‚úèÔ∏è Send Message</h3>
                        <div class="input-group">
                            <select id="messageType">
                                <option value="announcement">Announcement</option>
                                <option value="assignment">Assignment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <textarea id="messageContent" placeholder="Enter your message here..."></textarea>
                        </div>
                        <div class="file-input-wrapper">
                            <label class="file-input-label" for="fileInput">
                                üìé Attach Document
                            </label>
                            <input type="file" id="fileInput" class="file-input" onchange="handleFileSelect(event)">
                            <div id="fileName" class="file-name"></div>
                        </div>
                        <button onclick="sendMessage()">Send Message</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="dashboard hidden">
            <div class="sidebar" id="studentSidebar">
                <h3>üìã Menu</h3>
                <button class="sidebar-btn" onclick="viewAnnouncements()">üì¢ Announcements</button>
                <button class="sidebar-btn" onclick="viewAssignments()">üìù Assignments</button>
                <button class="sidebar-btn" onclick="myProfile()">üë§ My Profile</button>
                <button class="sidebar-btn" onclick="logout()" style="background: #e74c3c; margin-top: 20px;">üö™ Logout</button>
           
  <button onclick="document.getElementById('studentSidebar').classList.remove('open')">
  √ó Close
</button>

</button>

           
            </div>

            <div class="main-content">
                <div class="header">
                    <h2 id="studentDashboardTitle">Loading...</h2>
                    <button class="toggle-sidebar-btn" onclick="toggleStudentSidebar()">‚ò∞ Menu</button>
                </div>

                <div class="content-area">
                    <div id="notificationPermissionBanner" class="notification-permission hidden">
                        <span>üì¨ Enable notifications to receive real-time updates</span>
                        <button onclick="requestNotificationPermission()">Enable</button>
                    </div>

                    <div class="lecturers-list">
                        <h4>üë®‚Äçüè´ Lecturers in this Classroom</h4>
                        <div id="studentLecturersList">
                            <p style="color: #999; font-size: 13px;">Loading...</p>
                        </div>
                    </div>

                    <div id="studentMessagesContainer" class="messages-container">
                        <h3 style="margin-bottom: 15px; color: #333;">üìö Class Updates</h3>
                        <div id="studentMessagesList">
                            <p style="color: #999; text-align: center; padding: 20px;">Loading messages...</p>
                        </div>
                    </div>

                    <div class="message-input-section">
                        <h3>‚ùì Ask a Question</h3>
                        <div class="form-group">
                            <textarea id="studentQuestionContent" placeholder="Ask your question here..."></textarea>
                        </div>
                        <div class="file-input-wrapper">
                            <label class="file-input-label" for="studentFileInput">
                                üìé Attach Document
                            </label>
                            <input type="file" id="studentFileInput" class="file-input" onchange="handleStudentFileSelect(event)">
                            <div id="studentFileName" class="file-name"></div>
                        </div>
                        <button onclick="sendQuestion()">Send Question</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Class Available Screen -->
        <div id="noClassScreen" class="form-container hidden">
            <div class="waiting-message">
                <h2>‚ùå No Classroom Available</h2>
                <p>The classroom for this program hasn't been created yet.</p>
                <p style="margin-top: 10px;">Please wait for your lecturer to create the class.</p>
                
                <div style="margin-top: 40px;">
                    <button onclick="retryJoin()">üîÑ Try Again</button>
                    <button onclick="logout()" class="btn-secondary">Back to Home</button>
                </div>
            </div>

            <button class="chat-icon-btn" onclick="openFriendChat()" title="Chat with friends">
                üí¨
                <span class="chat-label">Chat with Friends</span>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAtK_FW9fIOihmnECEngkElA2QCsoRYUA0",
            authDomain: "studyhub-backend.firebaseapp.com",
            databaseURL: "https://studyhub-backend-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "studyhub-backend",
            storageBucket: "studyhub-backend.firebasestorage.app",
            messagingSenderId: "985257842533",
            appId: "1:985257842533:web:7cc7c9c0f74cc100ad338c",
            measurementId: "G-2FHPEF5XBQ"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
        const analytics = getAnalytics(app);

        // Store Firebase in window for global access
        window.database = database;
        window.storage = storage;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseGet = get;
        window.firebaseUpdate = update;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;

        console.log('Firebase initialized successfully');
    </script>

    <script>
        // Global state
        let currentUser = {
            role: null,
            name: null,
            email: null,
            program: null,
            semester: null,
            classroomId: null,
            userId: null
        };

        let selectedFile = null;
        let studentSelectedFile = null;
        let currentClassrooms = [];
        let activeClassroomId = null;

        const SECURITY_CODE = "7907";

        // Check for auto-login on page load
        window.onload = function() {
            console.log('StudyHub initialized');
            checkAutoLogin();
        };

        function checkAutoLogin() {
            const savedUser = localStorage.getItem('studyhub_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    currentUser = user;
                    
                    if (user.role === 'lecturer') {
                        loadLecturerDashboard();
                    } else if (user.role === 'student') {
                        // Verify classroom still exists
                        const classroomRef = window.firebaseRef(window.database, 'classrooms/' + user.classroomId);
                        window.firebaseGet(classroomRef).then((snapshot) => {
                            if (snapshot.exists()) {
                                loadStudentDashboard();
                            } else {
                                localStorage.removeItem('studyhub_user');
                                showScreen('roleSelection');
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('studyhub_user');
                }
            }
        }

        function saveUserToLocalStorage() {
            localStorage.setItem('studyhub_user', JSON.stringify(currentUser));
        }

        // Helper functions
        function hideAllScreens() {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('lecturerSecurity').classList.add('hidden');
            document.getElementById('createClassroom').classList.add('hidden');
            document.getElementById('studentJoin').classList.add('hidden');
            document.getElementById('lecturerDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('noClassScreen').classList.add('hidden');
        }

        function showScreen(screenId) {
            hideAllScreens();
            document.getElementById(screenId).classList.remove('hidden');
        }

        function selectRole(role) {
            currentUser.role = role;
            if (role === 'lecturer') {
                showScreen('lecturerSecurity');
            } else {
                showScreen('studentJoin');
            }
        }

        function verifySecurityCode() {
            const code = document.getElementById('securityCode').value;
            const errorDiv = document.getElementById('securityError');
            
            if (code === SECURITY_CODE) {
                errorDiv.classList.add('hidden');
                showScreen('createClassroom');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        function validateProgramName(programName) {
            const lowerProgram = programName.toLowerCase().trim();
            return lowerProgram.startsWith('diploma') || 
                   lowerProgram.startsWith('bachelor') || 
                   lowerProgram.startsWith('basics');
        }

        function createClassroom() {
            const programName = document.getElementById('programName').value.trim();
            const semester = document.getElementById('semester').value;
            const email = document.getElementById('lecturerEmail').value.trim();
            const errorDiv = document.getElementById('programError');

            if (!validateProgramName(programName)) {
                errorDiv.classList.remove('hidden');
                return;
            }

            if (!semester || !email) {
                alert('Please fill in all fields');
                return;
            }

            errorDiv.classList.add('hidden');

            // Create classroom ID
            const classroomId = programName.toLowerCase().replace(/\s+/g, '-') + '-sem' + semester;
            const userId = email.replace(/[^a-zA-Z0-9]/g, '-');
            
            // Save to Firebase
            const classroomRef = window.firebaseRef(window.database, 'classrooms/' + classroomId);
            window.firebaseSet(classroomRef, {
                programName: programName,
                semester: semester,
                lecturerEmail: email,
                lecturerId: userId,
                createdAt: new Date().toISOString()
            }).then(() => {
                // Add lecturer to lecturers list
                const lecturerRef = window.firebaseRef(window.database, 'classrooms/' + classroomId + '/lecturers/' + userId);
                window.firebaseSet(lecturerRef, {
                    email: email,
                    joinedAt: new Date().toISOString()
                });

                // Save to user's classrooms
                const userClassroomRef = window.firebaseRef(window.database, 'users/' + userId + '/classrooms/' + classroomId);
                window.firebaseSet(userClassroomRef, {
                    programName: programName,
                    semester: semester,
                    createdAt: new Date().toISOString()
                });

                currentUser.program = programName;
                currentUser.semester = semester;
                currentUser.email = email;
                currentUser.classroomId = classroomId;
                currentUser.userId = userId;
                activeClassroomId = classroomId;
                
                saveUserToLocalStorage();
                loadLecturerDashboard();
            }).catch((error) => {
                alert('Error creating classroom: ' + error.message);
            });
        }

        function joinClassroom() {
            const programName = document.getElementById('studentProgram').value.trim();
            const semester = document.getElementById('studentSemester').value;
            const studentName = document.getElementById('studentName').value.trim();
            const errorDiv = document.getElementById('studentProgramError');

            if (!validateProgramName(programName)) {
                errorDiv.classList.remove('hidden');
                return;
            }

            if (!semester || !studentName) {
                alert('Please fill in all fields');
                return;
            }

            errorDiv.classList.add('hidden');

            // Check if classroom exists
            const classroomId = programName.toLowerCase().replace(/\s+/g, '-') + '-sem' + semester;
            const classroomRef = window.firebaseRef(window.database, 'classrooms/' + classroomId);
            
            window.firebaseGet(classroomRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // Classroom exists, join it
                    const userId = studentName.replace(/\s+/g, '-').toLowerCase() + '-' + Date.now();
                    currentUser.program = programName;
                    currentUser.semester = semester;
                    currentUser.name = studentName;
                    currentUser.classroomId = classroomId;
                    currentUser.userId = userId;

                    // Add student to classroom
                    const studentRef = window.firebaseRef(window.database, 'classrooms/' + classroomId + '/students/' + userId);
                    window.firebaseSet(studentRef, {
                        name: studentName,
                        joinedAt: new Date().toISOString()
                    });

                    saveUserToLocalStorage();
                    loadStudentDashboard();
                } else {
                    // Classroom doesn't exist
                    showScreen('noClassScreen');
                }
            }).catch((error) => {
                alert('Error checking classroom: ' + error.message);
            });
        }

        function loadLecturerDashboard() {
            showScreen('lecturerDashboard');
            loadLecturerClassrooms();
            
            if (activeClassroomId) {
                loadClassroomData(activeClassroomId);
            }
        }

        function loadLecturerClassrooms() {
            const userId = currentUser.userId;
            const userClassroomsRef = window.firebaseRef(window.database, 'users/' + userId + '/classrooms');
            
            window.firebaseOnValue(userClassroomsRef, (snapshot) => {
                const classList = document.getElementById('classList');
                classList.innerHTML = '<h4 style="color: white; font-size: 14px; margin-bottom: 10px;">My Classes</h4>';
                
                if (snapshot.exists()) {
                    currentClassrooms = [];
                    snapshot.forEach((childSnapshot) => {
                        const classroomId = childSnapshot.key;
                        const classData = childSnapshot.val();
                        currentClassrooms.push({ id: classroomId, ...classData });
                        
                        const classDiv = document.createElement('div');
                        classDiv.className = 'class-list-item' + (classroomId === activeClassroomId ? ' active' : '');
                        classDiv.textContent = classData.programName + ' - Sem ' + classData.semester;
                        classDiv.onclick = () => switchClassroom(classroomId);
                        classList.appendChild(classDiv);
                    });

                    if (!activeClassroomId && currentClassrooms.length > 0) {
                        activeClassroomId = currentClassrooms[0].id;
                        loadClassroomData(activeClassroomId);
                    }
                }
            });
        }

        function switchClassroom(classroomId) {
            activeClassroomId = classroomId;
            currentUser.classroomId = classroomId;
            saveUserToLocalStorage();
            loadClassroomData(classroomId);
            
            // Update active class styling
            document.querySelectorAll('.class-list-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function loadClassroomData(classroomId) {
            const classroomRef = window.firebaseRef(window.database, 'classrooms/' + classroomId);
            
            window.firebaseGet(classroomRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('dashboardTitle').textContent = data.programName + ' - Semester ' + data.semester;
                    currentUser.program = data.programName;
                    currentUser.semester = data.semester;
                }
            });

            loadLecturersInClassroom(classroomId);
            loadMessages(classroomId);
        }

        function loadLecturersInClassroom(classroomId) {
            const lecturersRef = window.firebaseRef(window.database, 'classrooms/' + classroomId + '/lecturers');
            
            window.firebaseOnValue(lecturersRef, (snapshot) => {
                const lecturersList = document.getElementById('lecturersList');
                lecturersList.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const lecturer = childSnapshot.val();
                        const lecturerDiv = document.createElement('div');
                        lecturerDiv.className = 'lecturer-item';
                        lecturerDiv.textContent = lecturer.email;
                        lecturersList.appendChild(lecturerDiv);
                    });
                } else {
                    lecturersList.innerHTML = '<p style="color: #999; font-size: 13px;">No lecturers yet</p>';
                }
            });
        }

        function loadStudentDashboard() {
            showScreen('studentDashboard');
            
            const classroomRef = window.firebaseRef(window.database, 'classrooms/' + currentUser.classroomId);
            window.firebaseGet(classroomRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('studentDashboardTitle').textContent = data.programName + ' - Semester ' + data.semester;
                }
            });

            loadStudentLecturers();
            loadStudentMessages();
            checkNotificationPermission();
        }

        function loadStudentLecturers() {
            const lecturersRef = window.firebaseRef(window.database, 'classrooms/' + currentUser.classroomId + '/lecturers');
            
            window.firebaseOnValue(lecturersRef, (snapshot) => {
                const lecturersList = document.getElementById('studentLecturersList');
                lecturersList.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const lecturer = childSnapshot.val();
                        const lecturerDiv = document.createElement('div');
                        lecturerDiv.className = 'lecturer-item';
                        lecturerDiv.textContent = lecturer.email;
                        lecturersList.appendChild(lecturerDiv);
                    });
                } else {
                    lecturersList.innerHTML = '<p style="color: #999; font-size: 13px;">No lecturers yet</p>';
                }
            });
        }

        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return;
            }

            if (Notification.permission === "default") {
                document.getElementById('notificationPermissionBanner').classList.remove('hidden');
            }
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    document.getElementById('notificationPermissionBanner').classList.add('hidden');
                    new Notification("StudyHub Notifications", {
                        body: "You will now receive real-time updates!",
                        icon: "üìö"
                    });
                }
            });
        }

        function sendNotification(title, body) {
            if (!("Notification" in window)) {
                return;
            }

            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: "üìö",
                    badge: "üì¢"
                });
            }
        }

        function loadMessages(classroomId) {
            const messagesRef = window.firebaseRef(window.database, 'classrooms/' + (classroomId || currentUser.classroomId) + '/messages');
            
            let isFirstLoad = true;
            
            window.firebaseOnValue(messagesRef, (snapshot) => {
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Sort by timestamp (newest first)
                    messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Send notification for new messages (only after first load)
                    if (!isFirstLoad && messages.length > 0 && currentUser.role === 'student') {
                        const latestMessage = messages[0];
                        sendNotification(
                            latestMessage.type === 'assignment' ? 'üìù New Assignment' : 'üì¢ New Announcement',
                            latestMessage.content.substring(0, 100)
                        );
                    }

                    messages.forEach((message) => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message-item';
                        
                        const time = new Date(message.timestamp).toLocaleString();
                        
                        let attachmentHtml = '';
                        if (message.attachmentUrl) {
                            const fileName = message.attachmentName || 'Download File';
                           attachmentHtml = `
                          <div class="message-attachment">
                            <a href="view.html?url=${encodeURIComponent(message.attachmentUrl)}&name=${encodeURIComponent(message.attachmentName)}" target="_blank" class="attachment-link">
                           üìé ${fileName}
                             </a>
                                   </div>
                                      `;

                        }

                        messageDiv.innerHTML = `
                            <div class="message-header">
                                <span class="message-type">${message.type}</span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-text">${message.content}</div>
                            ${attachmentHtml}
                        `;
                        
                        messagesList.appendChild(messageDiv);
                    });

                    isFirstLoad = false;
                } else {
                    messagesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No messages yet.</p>';
                }
            });
        }

messageDiv.oncontextmenu = function(e) {
    e.preventDefault();

    const menu = document.createElement('div');
    menu.className = 'attachment-menu';
    menu.style.top = e.pageY + 'px';
    menu.style.left = e.pageX + 'px';
    menu.innerHTML = `
        <div onclick="openDocument('${message.attachmentUrl}')">Open</div>
        <div onclick="deleteDocument('${classroomId}', '${message.id}')">Delete</div>
        <div onclick="forwardDocument('${message.attachmentUrl}', '${message.attachmentName}')">Forward</div>
    `;
    document.body.appendChild(menu);

    document.addEventListener('click', () => menu.remove(), { once: true });
};

function openDocument(url) {
    window.open(url, '_blank');
}

function deleteDocument(classroomId, messageId) {
    if(confirm('Delete this document?')) {
        const ref = window.firebaseRef(window.database, `classrooms/${classroomId}/messages/${messageId}`);
        window.firebaseSet(ref, null);
    }
}

function forwardDocument(url, name) {
    alert(`Forwarding ${name}...`);
    // Implement forward logic (e.g., create new message with same attachmentUrl)
}


        function loadStudentMessages() {
            const messagesRef = window.firebaseRef(window.database, 'classrooms/' + currentUser.classroomId + '/messages');
            
            let isFirstLoad = true;
            
            window.firebaseOnValue(messagesRef, (snapshot) => {
                const messagesList = document.getElementById('studentMessagesList');
                messagesList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Sort by timestamp (newest first)
                    messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Send notification for new messages (only after first load)
                    if (!isFirstLoad && messages.length > 0) {
                        const latestMessage = messages[0];
                        if (latestMessage.type !== 'question') {
                            sendNotification(
                                latestMessage.type === 'assignment' ? 'üìù New Assignment' : 'üì¢ New Announcement',
                                latestMessage.content.substring(0, 100)
                            );
                        }
                    }

                    messages.forEach((message) => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message-item';
                        
                        const time = new Date(message.timestamp).toLocaleString();
                        
                        let attachmentHtml = '';
                        if (message.attachmentUrl) {
                            const fileName = message.attachmentName || 'Download File';
                            attachmentHtml = `
                                <div class="message-attachment">
                                    <a href="${message.attachmentUrl}" target="_blank" class="attachment-link">
                                        üìé ${fileName}
                                    </a>
                                </div>
                            `;
                        }

                        let senderHtml = message.sender ? `<span class="message-time">From: ${message.sender}</span>` : '';

                        messageDiv.innerHTML = `
                            <div class="message-header">
                                <span class="message-type">${message.type}</span>
                                <span class="message-time">${time}</span>
                                ${senderHtml}
                            </div>
                            <div class="message-text">${message.content}</div>
                            ${attachmentHtml}
                        `;
                        
                        messagesList.appendChild(messageDiv);
                    });

                    isFirstLoad = false;
                } else {
                    messagesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No messages yet.</p>';
                }
            });
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('fileName').textContent = 'üìÑ ' + selectedFile.name;
            } else {
                document.getElementById('fileName').textContent = '';
            }
        }

        function handleStudentFileSelect(event) {
            studentSelectedFile = event.target.files[0];
            if (studentSelectedFile) {
                document.getElementById('studentFileName').textContent = 'üìÑ ' + studentSelectedFile.name;
            } else {
                document.getElementById('studentFileName').textContent = '';
            }
        }

        async function uploadFile(file) {
            if (!file) return null;

            const timestamp = Date.now();
            const fileName = timestamp + '_' + file.name;
            const fileRef = window.storageRef(window.storage, 'attachments/' + fileName);
            
            try {
                await window.uploadBytes(fileRef, file);
                const downloadURL = await window.getDownloadURL(fileRef);
                return { url: downloadURL, name: file.name };
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Error uploading file: ' + error.message);
                return null;
            }
        }

        async function sendMessage() {
            const type = document.getElementById('messageType').value;
            const content = document.getElementById('messageContent').value.trim();

            if (!content) {
                alert('Please enter a message');
                return;
            }

            let attachmentData = null;
            if (selectedFile) {
                attachmentData = await uploadFile(selectedFile);
                if (!attachmentData) return;
            }

            const messagesRef = window.firebaseRef(window.database, 'classrooms/' + activeClassroomId + '/messages');
            const newMessageRef = window.firebasePush(messagesRef);
            
            const messageData = {
                type: type,
                content: content,
                timestamp: new Date().toISOString(),
                sender: currentUser.email
            };

            if (attachmentData) {
                messageData.attachmentUrl = attachmentData.url;
                messageData.attachmentName = attachmentData.name;
            }

            window.firebaseSet(newMessageRef, messageData).then(() => {
                document.getElementById('messageContent').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileName').textContent = '';
                selectedFile = null;
                alert('Message sent successfully!');
            }).catch((error) => {
                alert('Error sending message: ' + error.message);
            });
        }

        async function sendQuestion() {
            const content = document.getElementById('studentQuestionContent').value.trim();

            if (!content) {
                alert('Please enter your question');
                return;
            }

            let attachmentData = null;
            if (studentSelectedFile) {
                attachmentData = await uploadFile(studentSelectedFile);
                if (!attachmentData) return;
            }

            const messagesRef = window.firebaseRef(window.database, 'classrooms/' + currentUser.classroomId + '/messages');
            const newMessageRef = window.firebasePush(messagesRef);
            
            const messageData = {
                type: 'question',
                content: content,
                timestamp: new Date().toISOString(),
                sender: currentUser.name
            };

            if (attachmentData) {
                messageData.attachmentUrl = attachmentData.url;
                messageData.attachmentName = attachmentData.name;
            }

            window.firebaseSet(newMessageRef, messageData).then(() => {
                document.getElementById('studentQuestionContent').value = '';
                document.getElementById('studentFileInput').value = '';
                document.getElementById('studentFileName').textContent = '';
                studentSelectedFile = null;
                alert('Question sent successfully!');
            }).catch((error) => {
                alert('Error sending question: ' + error.message);
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleStudentSidebar() {
            document.getElementById('studentSidebar').classList.toggle('open');
        }

        function showAddClassForm() {
            // Clear form
            document.getElementById('programName').value = '';
            document.getElementById('semester').value = '';
            document.getElementById('lecturerEmail').value = currentUser.email;
            
            showScreen('createClassroom');
        }

        function startVideoCall() {
            alert('üé• Starting Video Class...\n\nThis will launch a video conference room where students can join.\n\nIntegration with services like Zoom, Google Meet, or custom WebRTC solution would be implemented here.');
        }

        function startVoiceCall() {
            alert('üé§ Starting Voice Class...\n\nThis will launch an audio conference room where students can join.\n\nIntegration with voice call services would be implemented here.');
        }

        function viewStudents() {
            const classroomRef = window.firebaseRef(window.database, 'classrooms/' + activeClassroomId + '/students');
            window.firebaseGet(classroomRef).then((snapshot) => {
                let studentList = 'Students in this class:\n\n';
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        studentList += '‚Ä¢ ' + child.val().name + '\n';
                    });
                } else {
                    studentList = 'No students have joined yet.';
                }
                alert(studentList);
            });
        }

        function viewAnalytics() {
            alert('üìä Analytics Dashboard\n\nThis will show:\n‚Ä¢ Student engagement\n‚Ä¢ Assignment completion rates\n‚Ä¢ Class attendance\n‚Ä¢ Message statistics');
        }

        function settings() {
            alert('‚öôÔ∏è Settings\n\nThis will allow you to:\n‚Ä¢ Update classroom details\n‚Ä¢ Manage permissions\n‚Ä¢ Configure notifications\n‚Ä¢ Export data');
        }

        function viewAnnouncements() {
            alert('üì¢ Showing announcements only...');
        }

        function viewAssignments() {
            alert('üìù Showing assignments only...');
        }

        function myProfile() {
            alert('üë§ My Profile\n\nStudent: ' + currentUser.name + '\nProgram: ' + currentUser.program + '\nSemester: ' + currentUser.semester);
        }

        function openFriendChat() {
            alert('üí¨ Friend Chat\n\nThis feature allows you to chat with other students who are waiting for class.\n\nA peer-to-peer chat system would be implemented here.');
        }

        function retryJoin() {
            showScreen('studentJoin');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('studyhub_user');
                currentUser = {
                    role: null,
                    name: null,
                    email: null,
                    program: null,
                    semester: null,
                    classroomId: null,
                    userId: null
                };
                activeClassroomId = null;
                showScreen('roleSelection');
            }
        }

        function goBack() {
            if (currentUser.role === 'lecturer' && currentClassrooms.length > 0) {
                loadLecturerDashboard();
            } else {
                showScreen('roleSelection');
            }
        }

        // Make functions globally accessible
        window.selectRole = selectRole;
        window.verifySecurityCode = verifySecurityCode;
        window.createClassroom = createClassroom;
        window.joinClassroom = joinClassroom;
        window.sendMessage = sendMessage;
        window.sendQuestion = sendQuestion;
        window.toggleSidebar = toggleSidebar;
        window.toggleStudentSidebar = toggleStudentSidebar;
        window.startVideoCall = startVideoCall;
        window.startVoiceCall = startVoiceCall;
        window.viewStudents = viewStudents;
        window.viewAnalytics = viewAnalytics;
        window.settings = settings;
        window.viewAnnouncements = viewAnnouncements;
        window.viewAssignments = viewAssignments;
        window.myProfile = myProfile;
        window.openFriendChat = openFriendChat;
        window.retryJoin = retryJoin;
        window.logout = logout;
        window.goBack = goBack;
        window.handleFileSelect = handleFileSelect;
        window.handleStudentFileSelect = handleStudentFileSelect;
        window.showAddClassForm = showAddClassForm;
        window.requestNotificationPermission = requestNotificationPermission;
    </script>
</body>
</html>
