<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Program Chat + Online Class</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-blur: rgba(0,0,0,.45);
    --card: rgba(255,255,255,.55);
    --accent: #22c55e;
    --accent-600:#16a34a;
    --accent-700:#15803d;
    --accent-grad: linear-gradient(135deg,#22c55e,#16a34a);
    --danger:#ef4444;
    --warning:#f97316;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }

  body {
    margin:0;
    font-family: Inter, system-ui, sans-serif;
    display:flex;
    overflow:hidden;
    position:relative;
    background: url('https://tse1.mm.bing.net/th/id/OIP.3c8qmloF2JlR2Ond1fZg7QHaE8?cb=ucfimg2ucfimg=1&rs=1&pid=ImgDetMain&o=7&rm=3') 
                center/cover fixed no-repeat;
  }

  body::before {
    content:''; position:absolute; inset:0;
    background: var(--bg-blur);
    backdrop-filter: blur(12px);
    z-index:0;
  }

  /* Sidebar */
  #sidebar{
    position:absolute; left:-240px; top:0; height:100%; width:220px; z-index:3;
    background: linear-gradient(135deg, rgba(0, 68, 255, 0.25), rgba(0, 255, 0, 0.336));
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255,255,255,0.25);
    color:#fff;
    padding:20px 14px;
    border-radius:0 20px 20px 0;
    display:flex; flex-direction:column; gap:14px; transition:left .4s ease;
    font-weight:500; letter-spacing:.2px
  }
  #sidebar.show{ left:0; }
  .side-title{ font-weight:700; letter-spacing:.3px; opacity:.85; margin-bottom:6px }
  .sidebar-btn{
    display:flex; align-items:center; gap:12px; width:100%; padding:12px 14px; border-radius:999px; cursor:pointer; border:1px solid rgba(255,255,255,.08);
    background: rgba(0, 0, 0, 0.5); transition: transform .18s ease, background .18s ease, box-shadow .18s ease;
  }
  .sidebar-btn:hover{ transform: translateX(6px); background: rgba(255,255,255,.12); box-shadow:0 6px 20px rgba(0,0,0,.25) }
  .chip{ margin-left:auto; padding:2px 8px; border-radius:999px; font-size:11px; background:rgba(255,255,255,.15) }

  /* Shell */
  #chat-container{ position:relative; z-index:1; flex:1; display:flex; flex-direction:column }
  header{
    display:flex; align-items:center; justify-content:space-between; color:#fff; padding:14px 18px;
    background: rgba(4, 231, 4, 0.459); backdrop-filter: blur(12px);
    border-bottom:1px solid rgba(255,255,255,.25);
  }
  #back-btn,#menu-btn{ cursor:pointer; user-select:none }
  #chat-header{ font-weight:700; letter-spacing:.2px }

  /* Banner for class */
  #class-notification{
    position:absolute; left:50%; transform:translateX(-50%); top:66px;
    display:none; align-items:center; gap:12px; background: var(--warning); color:#fff; font-weight:700; font-size: x-small;
    padding:9px 7px; border-radius:700px; box-shadow:0 10px 25px rgba(0,0,0,.25)
  }
  #class-notification button{
    background:#fff; color:#9a3412; border:none; padding:8px 14px; border-radius:999px; font-weight:700; cursor:pointer
  }

  /* Messages area */
  #messages{ flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px }
  .message{ max-width:72%; padding:12px 14px; border-radius:16px; position:relative; animation:fade .25s ease; font-size:15px; line-height:1.45 }
  .message .sender{ display:block; font-size:12px; font-weight:700; opacity:.7; margin-bottom:4px }
  .message .timestamp{ display:block; font-size:11px; opacity:.55; margin-top:6px; text-align:right }

  .sent {
    align-self: flex-end;
    color: #fffdfd;
    background: linear-gradient(135deg, rgba(67, 197, 34, 0.438), rgba(5, 150, 105, 0.5));
    backdrop-filter: blur(8px);
    border-radius: 12px 12px 9px 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    padding: 10px 15px;
    max-width: 70%;
    opacity: 0;
    animation: slidePopRight 0.6s ease forwards;
    bottom:70px
  }

  .received {
    align-self: flex-start;
    color: #ffffff;
    background: linear-gradient(135deg, rgba(0, 68, 255, 0.445), rgba(0, 255, 0, 0.5));
    backdrop-filter: blur(8px);
    border-radius: 12px 12px 12px 6px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    padding: 10px 15px;
    max-width: 70%;
    opacity: 0;
    animation: slidePopLeft 0.6s ease forwards;
    bottom:70px
  }

  @keyframes slidePopRight {
    0% { transform: translateX(50px) scale(0.9); opacity: 0; }
    60% { transform: translateX(-5px) scale(1.05); opacity: 1; }
    100% { transform: translateX(0) scale(1); opacity: 1; }
  }
  @keyframes slidePopLeft {
    0% { transform: translateX(-50px) scale(0.9); opacity: 0; }
    60% { transform: translateX(5px) scale(1.05); opacity: 1; }
    100% { transform: translateX(0) scale(1); opacity: 1; }
  }

  /* Input */
  #input-area{
    position:fixed; left:0; right:0; bottom:0; padding:10px 12px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    display:flex; gap:10px; border-top:1px solid rgba(255,255,255,.25);
    z-index:4;
  }
  #message-input{ flex:1; min-height:40px; max-height:140px; padding:12px 14px; border:1px solid #d1d5db; border-radius:999px; outline:none; resize:none; font-size:15px }
  #message-input:focus{ border-color: var(--accent) }
  .icon-btn{ width:42px; height:42px; border:none; border-radius:999px; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; transition: transform .15s ease, box-shadow .2s ease }
  .icon-btn:hover{ transform: translateY(-1px); box-shadow:0 8px 22px rgba(34,197,94,.35) }
  .icon-btn.secondary{ background:#0ea5e9 }

  @keyframes fade{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

  @media(max-width:520px){ .message{ max-width:88% } }

  /* Video classroom modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:30 }
  .modal.show{ display:flex }
  .class-card{
    width:min(100%,980px); height:min(84vh,680px);
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(22px) saturate(180%);
    -webkit-backdrop-filter: blur(22px) saturate(180%);
    border-radius:18px;
    overflow:hidden;
    color:#e5e7eb;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
    display:grid;
    grid-template-columns: 1.4fr .6fr;
    border:1px solid rgba(255,255,255,0.25);
  }
  .stage{ position:relative; background: radial-gradient(1200px 600px at 50% 10%,#0f172a 0%,#0b1220 55%,#0b1220 100%) }
  video{ background:#000; width:100%; height:100%; object-fit:cover }
  #localVideo{ position:absolute; right:14px; bottom:14px; width:200px; height:120px; border-radius:12px; border:2px solid rgba(255,255,255,.2); box-shadow:0 10px 25px rgba(0,0,0,.5) }
  .panel{ background: rgba(255,255,255,0.1); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-left:1px solid rgba(255,255,255,.25); display:flex; flex-direction:column; }
  .panel header{ background:transparent; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.25) }
  .panel-body{ padding:12px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:10px }
  .panel .row{ display:flex; align-items:center; gap:8px; justify-content:space-between; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); padding:10px 12px; border-radius:12px }
  .controls{ display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.06) }
  .ctl{ flex:1; padding:6px 8px; border-radius:12px; border:none; cursor:pointer; font-weight:700 }
  .ctl.primary{ background:var(--accent); color:#fff }
  .ctl.warn{ background:#0b49f5; color:#0a0a0a }
  .ctl.danger{ background:var(--danger); color:#fff }
  .pill{ padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px }
</style>

<!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0LTZS1S9W6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-0LTZS1S9W6');
  </script>

</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="side-title">StudyHub ‚Ä¢ Menu</div>
  <div class="sidebar-btn" onclick="location.href='upload.html'"><i></i> <span>Upload</span></div>
  <div class="sidebar-btn" onclick="location.href='wisdom.html'"><i></i> <span>Wisdom</span></div>
  <div class="sidebar-btn" id="open-classes"><i>üéì</i> <span>Classes</span><span class="chip" id="class-chip">0</span></div>
  <div class="sidebar-btn" id="start-test-class"><i>üß™</i> <span>start Class</span></div>
</div>

<!-- Main -->
<div id="chat-container">
  <header>
    <div id="back-btn" onclick="location.href='index.html'">üè† Home</div>
    <div id="chat-header">Program Chat</div>
    <div id="menu-btn">‚ò∞</div>
  </header>

  <div id="class-notification">
    <span id="class-title">üì¢ Online Class is Live!</span>
    <button id="join-class-btn">Join</button>
  </div>

  <div id="messages" aria-live="polite"></div>

  <div id="typing-indicator" style="font-size:12px; color:gray; margin:6px 0;"></div>

  <div id="input-area">
    <textarea id="message-input" rows="1" placeholder="Type a message‚Ä¶"></textarea>
    <button class="icon-btn secondary" id="mic-btn" title="Voice input">üéôÔ∏è</button>
    <button class="icon-btn" id="send-btn" title="Send">‚û§</button>
  </div>
</div>

<!-- Classroom Modal -->
<div class="modal" id="class-modal" aria-hidden="true">
  <div class="class-card" role="dialog" aria-modal="true">
    <div class="stage">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div class="panel">
      <header>
        <div style="display:flex;align-items:center;gap:10px">
          <strong id="room-title">Online Classroom</strong>
          <span class="pill" id="room-pill">connecting‚Ä¶</span>
        </div>
      </header>
      <div class="panel-body">
        <div class="row"><span>Room ID</span><code id="room-id">‚Äî</code></div>
        <div class="row"><span>Status</span><span id="room-status">Idle</span></div>
        <div class="row"><span>Participants</span><span id="room-peers">1</span></div>
        <div class="row"><span>Class Code</span><code id="room-code">‚Äî</code></div>
      </div>
      <div class="controls">
        <button class="ctl warn" id="toggle-mic">Mute</button>
        <button class="ctl warn" id="toggle-cam">Camera Off</button>
        <button class="ctl" id="share-screen" style="background:#3b82f6;color:#fff">Share Screen</button>
        <button class="ctl danger" id="leave-room">Leave</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp,
  getDocs, where, doc, setDoc, getDoc, updateDoc
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'

(async () => {
  /* ================= Firebase ================= */
  const firebaseConfig = {
    apiKey: 'AIzaSyAtK_FW9fIOihmnECEngkElA2QCsoRYUA0',
    authDomain: 'studyhub-backend.firebaseapp.com',
    projectId: 'studyhub-backend',
    storageBucket: 'studyhub-backend.firebasestorage.app',
    messagingSenderId: '985257842533',
    appId: '1:985257842533:web:cdba8c4138b3f7a3ad338c'
  }
  const app = initializeApp(firebaseConfig)
  const db = getFirestore(app)

  /* ================ DOM & UI ================ */
  const sidebar = document.getElementById('sidebar')
  const menuBtn = document.getElementById('menu-btn')
  const messagesDiv = document.getElementById('messages')
  const input = document.getElementById('message-input')
  const sendBtn = document.getElementById('send-btn')
  const micBtn = document.getElementById('mic-btn')
  const notif = document.getElementById('class-notification')
  const joinBtn = document.getElementById('join-class-btn')
  const classChip = document.getElementById('class-chip')
  const openClassesBtn = document.getElementById('open-classes')
  const startTestBtn = document.getElementById('start-test-class')

  // Classroom modal elements
  const modal = document.getElementById('class-modal')
  const remoteVideo = document.getElementById('remoteVideo')
  const localVideo = document.getElementById('localVideo')
  const roomIdEl = document.getElementById('room-id')
  const roomTitleEl = document.getElementById('room-title')
  const roomPill = document.getElementById('room-pill')
  const roomStatus = document.getElementById('room-status')
  const roomPeers = document.getElementById('room-peers')
  const roomCodeEl = document.getElementById('room-code')
  const btnMute = document.getElementById('toggle-mic')
  const btnCam = document.getElementById('toggle-cam')
  const btnShare = document.getElementById('share-screen')
  const btnLeave = document.getElementById('leave-room')

  menuBtn.addEventListener('click',()=> sidebar.classList.toggle('show'))

  function autosize(){ input.style.height='auto'; input.style.height = Math.min(140, input.scrollHeight) + 'px' }
  input.addEventListener('input', autosize)
  input.addEventListener('keypress', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage() } })

  /* ================ Username & Program ================ */
  async function getUserName(){
    const usersRef = collection(db,'users');
    let name
    while(true){
      name = prompt('Enter your name:') || ('User' + Math.floor(Math.random()*9999))
      const snapshot = await getDocs(query(usersRef, where('name','==',name)))
      if(snapshot.empty) break
      alert('Name in use, choose another.')
    }
    localStorage.setItem('userName', name)
    await addDoc(usersRef, {name})
    return name
  }
  let userName = localStorage.getItem('userName')
  if(!userName) userName = await getUserName()

  const program = localStorage.getItem('program') || 'General'
  document.getElementById('chat-header').innerText = program + ' Chat'

  /* ================ Typing indicator ================= */
  // typing doc per user+program (so different programs don't collide)
  let typingTimeout = null
  const typingDocRef = (name)=> doc(db, 'typing', `${program}::${name}`)

  input.addEventListener('input', () => {
    // set typing true
    setDoc(typingDocRef(userName), { user: userName, program, typing: true }, { merge: true }).catch(()=>{})
    clearTimeout(typingTimeout)
    typingTimeout = setTimeout(()=> {
      setDoc(typingDocRef(userName), { typing: false }, { merge: true }).catch(()=>{})
    }, 2500)
  })

  // clear typing when sending message
  function clearTypingNow(){
    setDoc(typingDocRef(userName), { typing: false }, { merge: true }).catch(()=>{})
    clearTimeout(typingTimeout)
  }

  onSnapshot(collection(db, 'typing'), snap => {
    const typingUsers = []
    snap.forEach(snapDoc => {
      const d = snapDoc.data()
      if(d.program === program && d.typing && d.user !== userName) typingUsers.push(d.user)
    })
    if(typingUsers.length > 0) {
      document.getElementById('typing-indicator').textContent = `‚úçÔ∏è ${typingUsers.join(', ')} is typing...`
    } else {
      document.getElementById('typing-indicator').textContent = ''
    }
  })

  /* ================ Notifications Permission ================ */
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      console.log('Notification permission:', permission);
    });
  }

  function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
      try {
        new Notification(title, { body, silent: false })
      } catch (e) { console.warn('Notification failed', e) }
    }
  }
  function playNotificationSound(){
    try {
      const audio = new Audio('https://www.myinstants.com/media/sounds/message-notification.mp3')
      audio.play().catch(()=>{})
    } catch (e) { /* ignore */ }
  }

  /* ================ Messages (realtime) ================ */
  const messagesQuery = query(collection(db,'chats',program,'messages'), orderBy('timestamp'))
  onSnapshot(messagesQuery, snapshot => {
    messagesDiv.innerHTML = ''
    snapshot.forEach(docSnap => {
      const data = docSnap.data()
      const div = document.createElement('div')
      div.classList.add('message', data.sender === userName ? 'sent' : 'received')
      const ts = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''
      div.innerHTML = `<span class="sender">${escapeHTML(data.sender)}</span><div class="text">${escapeHTML(data.text)}</div><span class="timestamp">${ts}</span>`
      messagesDiv.appendChild(div)

      // notifications and sound for other users
      if (data.sender !== userName) {
        showNotification(data.sender, data.text)
        playNotificationSound()
      }
    })
    messagesDiv.scrollTop = messagesDiv.scrollHeight
  })

  async function sendMessage(){
    const text = input.value.trim()
    if(!text) return
    await addDoc(collection(db,'chats',program,'messages'), { sender:userName, text, timestamp: serverTimestamp() })
    input.value=''; autosize(); clearTypingNow()
  }
  sendBtn.addEventListener('click', sendMessage)

  /* ================ Voice input ================ */
  micBtn.addEventListener('click',()=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition
    if(!SR){ alert('Voice input not supported on this browser'); return }
    const r = new SR(); r.lang='en-US';
    r.onresult = e=>{ input.value = e.results[0][0].transcript; autosize(); sendMessage() }
    r.onerror = ()=> { alert('Voice recognition error') }
    r.start()
  })

  /* ================ Online Class Banner & Test class ================ */
  const classesRef = collection(db,'classes')
  let currentLive = null
  let classDocUnsub = null
  let amILecturer = false
  let myClassDocId = null

  onSnapshot(classesRef, snap=>{
    let countUpcoming = 0
    currentLive = null
    snap.forEach(d=>{
      const c = d.data()
      if(c.program===program && (c.status==='upcoming' || c.status==='live')) countUpcoming++
      if(c.program===program && c.status==='live' && c.roomId) currentLive = {id:d.id, ...c}
    })
    classChip.textContent = String(countUpcoming)
    if(currentLive){
      notif.style.display = 'flex'
      document.getElementById('class-title').textContent = 'üì¢ ' + (currentLive.title || 'Class is Live')
    } else {
      notif.style.display = 'none'
    }
  })

  joinBtn.addEventListener('click', async ()=>{
    if(!currentLive){ alert('No live class for this program right now.'); return }
    const entered = prompt('Enter Class Code:')
    if(!entered) return
    if(currentLive.classCode && entered !== currentLive.classCode){ alert('Wrong class code ‚Äî you cannot join.'); return }
    await openClassroom(currentLive)
  })

  openClassesBtn.addEventListener('click', ()=> {
    if(currentLive) joinBtn.click()
    else alert('No live class at the moment. Check again later.')
  })

  startTestBtn.addEventListener('click', async ()=>{
    const title = prompt('Test Class Title','Demo Lecture') || 'Demo Lecture'
    try {
      const room = await createRoom()
      const code = Math.floor(100000 + Math.random()*900000).toString()
      const clsDoc = await addDoc(classesRef, { program, title, status:'live', roomId: room.id, classCode: code, createdAt: serverTimestamp() })
      myClassDocId = clsDoc.id
      amILecturer = true
      alert('Test class started. Room ID: '+room.id + '\nClass code: ' + code)
      await openClassroom({ id: clsDoc.id, title, roomId: room.id, classCode: code })
    } catch(e){
      console.error('Failed to start test class', e)
      alert('Failed to start test class ‚Äî check console.')
    }
  })

  /* ==================== WebRTC (single consistent implementation) ==================== */
  const rtcConfig = { iceServers:[ { urls: 'stun:stun.l.google.com:19302' } ] } // add TURN for production
  let pc = null
  let localStream = null
  let remoteStream = null
  let roomRef = null
  let unsubscribeCandidates = []

  function watchClassDoc(classDocId){
    if(classDocUnsub){ classDocUnsub(); classDocUnsub = null }
    const classDocRef = doc(db,'classes', classDocId)
    classDocUnsub = onSnapshot(classDocRef, snap=>{
      if(!snap.exists()) return
      const data = snap.data()
      if(data.status === 'ended'){
        if(modal.classList.contains('show')) {
          alert('Lecture ended the class.')
          closeRoom()
        }
      }
    })
  }

  async function getMedia() {
    if (localStream) return localStream
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      localVideo.srcObject = localStream
      return localStream
    } catch (err) {
      console.warn('getUserMedia failed', err)
      throw err
    }
  }

  async function createRoom(){
    await getMedia()
    pc = new RTCPeerConnection(rtcConfig)
    remoteStream = new MediaStream()
    remoteVideo.srcObject = remoteStream

    localStream.getTracks().forEach(t=> pc.addTrack(t, localStream))
    pc.ontrack = e => { e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t)); peersBump() }

    const roomCollection = collection(db,'rooms')
    roomRef = await addDoc(roomCollection, {})

    const callerCandidates = collection(db,'rooms', roomRef.id, 'callerCandidates')
    pc.onicecandidate = e=> { if(e.candidate) addDoc(callerCandidates, e.candidate.toJSON()) }

    const offer = await pc.createOffer()
    await pc.setLocalDescription(offer)
    await setDoc(roomRef, { offer: { type: offer.type, sdp: offer.sdp } }, { merge:true })

    // Listen for answer
    const unsubAnswer = onSnapshot(roomRef, async snap => {
      const data = snap.data()
      if(!pc.currentRemoteDescription && data && data.answer){
        const answerDesc = { type: data.answer.type, sdp: data.answer.sdp }
        await pc.setRemoteDescription(answerDesc)
        roomStatus.textContent = 'Connected'
        roomPill.textContent = 'live'
      }
    })
    unsubscribeCandidates.push(unsubAnswer)

    // callee ICE
    const calleeCandRef = collection(db,'rooms', roomRef.id, 'calleeCandidates')
    const unsubCallee = onSnapshot(calleeCandRef, candSnap=>{
      candSnap.docChanges().forEach(change=>{
        if(change.type==='added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()))
      })
    })
    unsubscribeCandidates.push(unsubCallee)

    roomIdEl.textContent = roomRef.id
    return roomRef
  }

  async function joinRoomById(id) {
    await getMedia()
    const roomDoc = doc(db,'rooms', id)
    const roomSnapshot = await getDoc(roomDoc)
    if(!roomSnapshot.exists()){ throw new Error('Room not found') }

    roomRef = roomDoc
    roomIdEl.textContent = id

    pc = new RTCPeerConnection(rtcConfig)
    remoteStream = new MediaStream()
    remoteVideo.srcObject = remoteStream

    localStream.getTracks().forEach(t=> pc.addTrack(t, localStream))
    pc.ontrack = e=> { e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t)); peersBump() }

    const calleeCandidates = collection(db,'rooms', id, 'calleeCandidates')
    pc.onicecandidate = e=> { if(e.candidate) addDoc(calleeCandidates, e.candidate.toJSON()) }

    const offer = roomSnapshot.data().offer
    await pc.setRemoteDescription({ type: offer.type, sdp: offer.sdp })

    const answer = await pc.createAnswer()
    await pc.setLocalDescription(answer)
    await updateDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp } })

    const callerCandRef = collection(db,'rooms', id, 'callerCandidates')
    const unsubCaller = onSnapshot(callerCandRef, candSnap=>{
      candSnap.docChanges().forEach(change=>{
        if(change.type==='added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()))
      })
    })
    unsubscribeCandidates.push(unsubCaller)

    roomStatus.textContent = 'Connected'
    roomPill.textContent = 'live'
  }

  async function openClassroom(meta){
    roomTitleEl.textContent = meta.title || 'Online Classroom'
    roomPill.textContent = 'connecting‚Ä¶'
    roomStatus.textContent = 'Connecting'
    roomPeers.textContent = '1'
    roomCodeEl.textContent = meta.classCode || '‚Äî'
    modal.classList.add('show')
    document.body.style.overflow='hidden'

    if(meta.id) watchClassDoc(meta.id)

    if(amILecturer && myClassDocId === meta.id){
      if(roomRef && roomRef.id) roomIdEl.textContent = roomRef.id
      roomStatus.textContent = 'Waiting for participants...'
      roomPill.textContent = 'live'
    } else {
      try {
        await joinRoomById(meta.roomId)
      } catch(e){
        alert('Failed to join room: ' + e.message)
        closeRoom()
      }
    }
  }

  function peersBump(){
    const r = (remoteStream && remoteStream.getTracks().filter(t=>t.enabled).length>0) ? 2 : 1
    roomPeers.textContent = String(r)
  }

  /* === Controls === */
  btnMute.addEventListener('click', () => {
    if(!localStream) return
    const audioTrack = localStream.getAudioTracks()[0]
    if (!audioTrack) return
    audioTrack.enabled = !audioTrack.enabled
    btnMute.textContent = audioTrack.enabled ? 'Mute' : 'Unmute'
  })

  btnCam.addEventListener('click', () => {
    if(!localStream) return
    const videoTrack = localStream.getVideoTracks()[0]
    if (!videoTrack) return
    videoTrack.enabled = !videoTrack.enabled
    btnCam.textContent = videoTrack.enabled ? 'Camera Off' : 'Camera On'
  })

  btnShare.addEventListener('click', async () => {
    if(!pc) return alert('No active session to share from')
    try {
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true })
      const screenTrack = screenStream.getTracks()[0]
      const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video')
      if(sender) await sender.replaceTrack(screenTrack)
      screenTrack.onended = async () => {
        const videoTrack = localStream.getVideoTracks()[0]
        if(sender && videoTrack) await sender.replaceTrack(videoTrack)
      }
    } catch (err) { console.error('Screen share failed:', err) }
  })

  btnLeave.addEventListener('click', async ()=>{
    try {
      if(amILecturer && myClassDocId){
        await updateDoc(doc(db,'classes', myClassDocId), { status: 'ended' })
      }
    } catch(e){ console.warn('Failed to update class status', e) }
    await closeRoom()
  })

  // close on clicking outside modal
  modal.addEventListener('click', e=>{ if(e.target===modal) btnLeave.click() })

  async function closeRoom(){
    try{
      if(classDocUnsub){ classDocUnsub(); classDocUnsub = null }
      unsubscribeCandidates.forEach(fn => fn && fn())
      unsubscribeCandidates = []

      if(pc){
        pc.getSenders().forEach(s=> { try{ s.track && s.track.stop() }catch{} })
        try{ pc.close() }catch{}
      }
    }catch(e){ console.warn(e) }
    pc = null
    try{ if(localStream){ localStream.getTracks().forEach(t=> t.stop()) } }catch{}
    localStream = null
    remoteStream = null
    localVideo.srcObject = null
    remoteVideo.srcObject = null
    modal.classList.remove('show')
    document.body.style.overflow='auto'
    roomStatus.textContent = 'Idle'
    roomPill.textContent = 'ended'
    roomIdEl.textContent = '‚Äî'
    roomCodeEl.textContent = '‚Äî'
    roomPeers.textContent = '1'
    amILecturer = false
    myClassDocId = null
  }

  /* ================ Helpers ================ */
  function escapeHTML(str=''){
    return String(str).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c] })
  }
})();
</script>
</body>
</html>
