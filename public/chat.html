<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Program Chat + Online Class</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* --- Keep your same styles as before --- */
  /* (No visual changes needed, only logic updates below) */
  :root{
    --bg-blur: rgba(0,0,0,.45);
    --card: rgba(255,255,255,.55);
    --accent: #22c55e;
    --accent-600:#16a34a;
    --accent-700:#15803d;
    --accent-grad: linear-gradient(135deg,#22c55e,#16a34a);
    --danger:#ef4444;
    --warning:#f97316;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body {
    margin:0;
    font-family: Inter, system-ui, sans-serif;
    display:flex;
    overflow:hidden;
    position:relative;
    background: url('https://tse1.mm.bing.net/th/id/OIP.3c8qmloF2JlR2Ond1fZg7QHaE8') center/cover fixed no-repeat;
  }
  body::before {
    content:''; position:absolute; inset:0;
    background: var(--bg-blur);
    backdrop-filter: blur(12px);
    z-index:0;
  }
  #sidebar{
    position:absolute; left:-240px; top:0; height:100%; width:220px; z-index:3;
    background: linear-gradient(135deg, rgba(0, 68, 255, 0.25), rgba(0, 255, 0, 0.336));
    backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255,255,255,0.25);
    color:#fff;
    padding:20px 14px;
    border-radius:0 20px 20px 0;
    display:flex; flex-direction:column; gap:14px; transition:left .4s ease;
  }
  #sidebar.show{ left:0; }
  .sidebar-btn{
    display:flex; align-items:center; gap:12px;
    width:100%; padding:12px 14px;
    border-radius:999px; cursor:pointer;
    background: rgba(0, 0, 0, 0.5);
  }
  header{
    display:flex; align-items:center; justify-content:space-between; color:#fff; padding:14px 18px;
    background: rgba(4, 231, 4, 0.459);
    border-bottom:1px solid rgba(255,255,255,.25);
  }
  #messages{ flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; color:white }
  #input-area{
    position:fixed; left:0; right:0; bottom:0; padding:10px 12px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    display:flex; gap:10px;
  }
  #message-input{ flex:1; border-radius:999px; padding:12px; }
  .icon-btn{ border-radius:999px; border:none; background:var(--accent); color:#fff; width:42px; height:42px; font-size:20px }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="side-title">StudyHub ‚Ä¢ Menu</div>
  <div class="sidebar-btn" onclick="location.href='upload.html'">Upload</div>
  <div class="sidebar-btn" onclick="location.href='wisdom.html'">Wisdom</div>
  <div class="sidebar-btn" id="open-classes">Classes <span class="chip" id="class-chip">0</span></div>
  <div class="sidebar-btn" id="start-test-class">Start Class</div>
</div>

<!-- Chat Area -->
<div id="chat-container">
  <header>
    <div id="back-btn" onclick="location.href='index.html'">üè† Home</div>
    <div id="chat-header">Loading Chat...</div>
    <div id="menu-btn">‚ò∞</div>
  </header>

  <div id="messages"></div>

  <div id="input-area">
    <textarea id="message-input" rows="1" placeholder="Type a message‚Ä¶"></textarea>
    <button class="icon-btn" id="send-btn">‚û§</button>
  </div>
</div>

<script type="module">
/* ==================== Firebase ==================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtK_FW9fIOihmnECEngkElA2QCsoRYUA0",
  authDomain: "studyhub-backend.firebaseapp.com",
  projectId: "studyhub-backend",
  storageBucket: "studyhub-backend.firebasestorage.app",
  messagingSenderId: "985257842533",
  appId: "1:985257842533:web:cdba8c4138b3f7a3ad338c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ==================== DOM Elements ==================== */
const chatHeader = document.getElementById("chat-header");
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");

/* ==================== Auth & User Info ==================== */
let user = null;
let userData = null;
let program = "";
let userName = "";

onAuthStateChanged(auth, async (currentUser) => {
  if (!currentUser) {
    location.href = "login.html"; // redirect if not logged in
    return;
  }
  user = currentUser;

  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (userDoc.exists()) {
    userData = userDoc.data();
    userName = userData.name || "Anonymous";
    program = userData.program || "General";
    chatHeader.textContent = `${program} Chat`;
  } else {
    chatHeader.textContent = "Unknown Program Chat";
  }

  // Start listening for messages only after we have program info
  startChatListener();
});

/* ==================== Chat Functions ==================== */
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  await addDoc(collection(db, "chats", program, "messages"), {
    sender: userName,
    text,
    timestamp: serverTimestamp()
  });
  input.value = "";
}

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function startChatListener() {
  const q = query(collection(db, "chats", program, "messages"), orderBy("timestamp"));
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const div = document.createElement("div");
      div.textContent = `${d.sender}: ${d.text}`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}
</script>

</body>
</html>
